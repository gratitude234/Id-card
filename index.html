<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ID Card Generator — Great Landmark College</title>

  <!-- libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">

  <style>
    :root{
      --blue:#0d2f6f;
      --yellow:#f9a825;
      --red:#e54c4c;
      --bg:#f4f7f6;
      --ink:#333;
      --radius:10px;
      --pad:16px;
      --shadow:0 4px 12px rgba(0,0,0,.10);

      /* paper */
      --page-w:210mm;   /* A4 default */
      --page-h:297mm;
      --duplex-rotate:180deg; /* long-edge by default */

      /* card mm sizes for print fidelity */
      --card-w:85.6mm;
      --card-h:54mm;
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial,sans-serif;
      background:var(--bg);
      color:var(--ink);
      padding:16px;
      display:flex;flex-direction:column;align-items:center
    }

    .container{
      background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);
      width:100%;max-width:980px;padding:20px;margin-bottom:20px
    }
    h1{margin:0 0 12px;text-align:center;color:var(--blue);font-size:26px}
    h2{margin:18px 0 8px;color:var(--blue);border-bottom:2px solid #eee;padding-bottom:6px;font-size:20px}

    /* grid */
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .col-6{grid-column:span 6}
    .col-12{grid-column:span 12}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

    /* form */
    .form-group{display:flex;flex-direction:column;gap:6px;position:relative}
    .form-group label{font-weight:600;color:#444;font-size:14px}
    .form-group input[type="text"], .form-group input[type="date"],
    .form-group input[type="url"], .form-group input[type="email"],
    .form-group select{
      padding:var(--pad);border:1px solid #ddd;border-radius:var(--radius);font-size:16px;background:#fff
    }
    .form-group input:focus,.form-group select:focus{outline:2px solid #5b9dd9;border-color:#5b9dd9}
    .help-text{font-size:12px;color:#777}
    .error-text{display:none;font-size:12px;color:#b00020}
    .student-controls{display:flex;gap:10px;align-items:center;margin-bottom:12px}
    .student-controls select{flex:1}

    .btn{
      background:var(--blue);color:#fff;border:0;border-radius:var(--radius);
      padding:12px 16px;font-weight:700;cursor:pointer;transition:.15s transform,.2s background
    }
    .btn:hover{background:#1e3a8a;transform:scale(1.02)}
    .btn:active{transform:scale(.98)}
    .btn.secondary{background:#eef2ff;color:#1e2a78;border:1px solid #dfe3ff}
    .btn:disabled{opacity:.5;cursor:not-allowed}

    .tools{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin:10px 0}

    /* preview card (screen) */
    .id-stage{display:flex;gap:18px;justify-content:center;flex-wrap:wrap}
    .id-card-wrapper{width:350px;aspect-ratio:85.6/54;position:relative;margin:12px auto 0}
    .id-card-container{position:absolute;inset:0;transform-style:preserve-3d;transition:transform .6s}
    .id-card-container.flipped{transform:rotateY(180deg)}
    .face{position:absolute;inset:0;background:#fff;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,.18);
      display:grid;grid-template-rows:40px 1fr auto;backface-visibility:hidden;overflow:hidden}
    .back{transform:rotateY(180deg)}

    .id-card-header{
      background:var(--blue);color:#fff;display:flex;align-items:center;gap:10px;
      padding:8px 14px;border-bottom:3px solid var(--yellow)
    }
    .id-card-header img.logo{
      width:28px;height:28px;border-radius:50%;object-fit:cover;background:#fff;flex-shrink:0
    }
    .id-card-header h3{margin:0;font-weight:800;font-size:15px;letter-spacing:.3px}

    .body-front{display:flex;gap:12px;align-items:flex-start;padding:12px}
    .photo{width:74px;height:74px;border:2px solid var(--yellow);border-radius:10px;overflow:hidden;flex-shrink:0}
    .photo img{width:100%;height:100%;object-fit:cover;object-position:center}

    .details{flex:1;min-width:0}
    .details h4{margin:0 0 6px;font-size:13px;color:var(--blue);border-bottom:1px solid #eee;padding-bottom:4px;font-weight:800}
    .kv{display:flex;gap:8px;margin:3px 0;font-size:11px;line-height:1.35}
    .kv strong{color:var(--blue);min-width:92px}
    .kv span{flex:1;min-width:0;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .kv.name span{font-weight:700}
    .kv.name.long span{font-size:10px}          /* smaller font if name is very long */

    .footer{background:var(--red);color:#fff;text-align:center;font-weight:700;font-size:9px;padding:6px 10px}

    /* printing surfaces */
    .print-page{display:none;width:var(--page-w);height:var(--page-h);position:relative}
    .grid-surface{
      position:absolute;inset:0;display:grid;justify-content:center;align-content:start
    }
    .id-card-wrapper.print{width:var(--card-w);height:var(--card-h)}
    .face.print{width:var(--card-w);height:var(--card-h);box-shadow:none;border-radius:2mm;border:1px dashed #ccc}

    .back-surface{transform:translate(var(--back-x,0),var(--back-y,0)) rotate(var(--duplex-rotate))}

    /* loading */
    .loading{display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
      background:rgba(0,0,0,.85);color:#fff;padding:10px 16px;border-radius:8px;z-index:1000}
    .loading.active{display:flex;gap:8px}
    .loading::before{content:"⏳"}

    /* PRINT */
    @media print{
      @page{size:auto;margin:0}
      html,body,*{-webkit-print-color-adjust:exact !important; print-color-adjust:exact !important; forced-color-adjust:none !important}
      body{background:#fff;padding:0;margin:0}
      .container,.id-stage,.tools,.form-section,.notes,.loading,h1,h2{display:none !important}

      .print-page{display:block;page-break-after:always}
      /* hide on-paper guides/borders for a clean output */
      .face.print{border:none !important}
      .id-card-header{background-color:var(--blue) !important;color:#fff !important;border-bottom-color:var(--yellow) !important}
      .footer{background-color:var(--red) !important;color:#fff !important}
    }

    /* responsive */
    @media (max-width:768px){
      body{padding:12px}
      .container{padding:16px}
      .grid{grid-template-columns:1fr}
      .col-6,.col-12{grid-column:span 1}
      .btn{width:100%}
      .id-card-wrapper{max-width:320px}
      .id-card-header h3{font-size:14px}
      .kv{font-size:10px}
      .footer{font-size:8px}
    }
  </style>
</head>
<body>
  <div class="container" aria-live="polite">
    <h1>Great Landmark College ID Card Generator</h1>

    <!-- FORM -->
    <div class="form-section">
      <h2>Enter Student Details</h2>

      <div class="student-controls">
        <div class="form-group">
          <label for="studentSelect">Select Student</label>
          <select id="studentSelect"></select>
        </div>
        <button class="btn secondary" id="addStudentBtn" type="button">Add Student</button>
        <button class="btn secondary" id="removeStudentBtn" type="button" disabled>Remove Selected</button>
      </div>

      <form id="form" novalidate>
        <div class="grid">
          <div class="col-6">
            <div class="form-group">
              <label for="studentName">Student Name</label>
              <input id="studentName" type="text" required value="ADEKUNLE SAMUEL" autocomplete="name"/>
              <div class="error-text" id="errName">Please enter a name.</div>
            </div>
          </div>

          <div class="col-6">
            <div class="form-group">
              <label for="dob">Date of Birth (DOB)</label>
              <input id="dob" type="date" required/>
              <div class="error-text" id="errDob">Please enter a valid date.</div>
            </div>
          </div>

          <div class="col-6">
            <div class="form-group">
              <label for="admissionNo">Admission No</label>
              <input id="admissionNo" type="text" required placeholder="GLC/2025/001"
                     pattern="^[A-Za-z]{3}\/\d{4}\/\d{3}$" value="GLC/2025/001"/>
              <div class="error-text" id="errAdm">Use format GLC/2025/001.</div>
            </div>
          </div>

          <div class="col-6">
            <div class="form-group">
              <label for="klass">Class</label>
              <input id="klass" type="text" required value="SS1 A"/>
              <div class="error-text" id="errClass">Please enter a class.</div>
            </div>
          </div>

          <div class="col-6">
            <div class="form-group">
              <label for="gender">Gender</label>
              <select id="gender" required>
                <option>Male</option><option>Female</option><option>Other</option>
              </select>
              <div class="error-text" id="errGender">Please select a gender.</div>
            </div>
          </div>

          <div class="col-6">
            <div class="form-group">
              <label for="validForYears">Valid For</label>
              <select id="validForYears">
                <option value="1" selected>1 year</option>
                <option value="2">2 years</option>
                <option value="3">3 years</option>
                <option value="4">4 years</option>
                <option value="5">5 years</option>
              </select>
            </div>
          </div>

          <div class="col-12">
            <label><input type="checkbox" id="showGender" checked> Show Gender on card</label>
          </div>

          <div class="col-12">
            <div class="form-group">
              <label for="photoUrl">Student Photo URL</label>
              <input id="photoUrl" type="url" placeholder="https://example.com/photo.jpg"
                     value="https://via.placeholder.com/300x300?text=Student"/>
              <div class="row">
                <input id="photoFile" type="file" accept="image/*,image/heic,image/heif"/>
                <span class="help-text">Upload overrides URL. We auto-crop to square and compress.</span>
              </div>
              <div class="error-text" id="errPhoto"></div>
            </div>
          </div>

          <div class="col-6">
            <div class="form-group">
              <label for="phone">Phone</label>
              <input id="phone" type="text" value="+234 801 123 4567"/>
            </div>
          </div>

          <div class="col-6">
            <div class="form-group">
              <label for="email">Email</label>
              <input id="email" type="email" value="info@greatlandmarkcollege.org"/>
            </div>
          </div>

          <div class="col-12">
            <div class="form-group">
              <label for="address">Address</label>
              <input id="address" type="text" value="45, Oke Alaro Rd, Abusoro, Akure"/>
            </div>
          </div>

          <div class="col-12">
            <div class="row">
              <button class="btn" type="submit">Update Preview</button>
              <button class="btn secondary" type="button" id="resetBtn">Reset</button>
            </div>
          </div>
        </div>
      </form>

      <div class="loading">Processing…</div>
    </div>

    <!-- OUTPUT -->
    <h2>Generated ID Card (Current Student)</h2>
    <div class="tools">
      <button class="btn secondary" id="flipBtn" type="button">Flip</button>
      <button class="btn secondary" id="printFrontsBtn" type="button">Print Fronts</button>
      <button class="btn secondary" id="printBacksBtn" type="button">Print Backs</button>

      <label class="btn secondary" style="display:inline-flex;gap:.5rem;align-items:center">
        Paper
        <select id="paperSize">
          <option value="A4" selected>A4</option>
          <option value="Letter">Letter</option>
        </select>
      </label>

      <label class="btn secondary" style="display:inline-flex;gap:.5rem;align-items:center">
        Duplex
        <select id="duplexMode">
          <option value="long" selected>Long-edge</option>
          <option value="short">Short-edge</option>
        </select>
      </label>

      <label class="btn secondary" style="display:inline-flex;gap:.5rem;align-items:center">
        Cards / sheet
        <select id="cardsPerPage">
          <option value="4" selected>4 (2×2)</option>
          <option value="8">8 (2×4)</option>
        </select>
      </label>

      <label style="display:flex;align-items:center;font-size:14px;color:#444">
        <input type="checkbox" id="imageMode"> Render as images (for tricky printers)
      </label>
    </div>

    <div class="id-stage" id="idStage"></div>
    <div id="printPages" aria-hidden="true"></div>

    <p class="notes" id="pageNote">
      Tip: Use “Cards / sheet” to place 4 or 8 IDs per page. For duplex, print fronts, then backs (long edge).
    </p>
  </div>

  <script>
  (function(){
    const CONFIG = {
      defaultPhoto:'https://via.placeholder.com/300x300?text=Student',
      defaultLogo:'/glc-logo.jpg',
      captureScale:2
    };

    const els = {
      form:document.getElementById('form'),
      idStage:document.getElementById('idStage'),
      printPages:document.getElementById('printPages'),
      loading:document.querySelector('.loading'),
      note:document.getElementById('pageNote'),
      tools:{
        flipBtn:document.getElementById('flipBtn'),
        printFrontsBtn:document.getElementById('printFrontsBtn'),
        printBacksBtn:document.getElementById('printBacksBtn'),
        paperSize:document.getElementById('paperSize'),
        duplexMode:document.getElementById('duplexMode'),
        cardsPerPage:document.getElementById('cardsPerPage'),
        imageMode:document.getElementById('imageMode'),
        addStudentBtn:document.getElementById('addStudentBtn'),
        removeStudentBtn:document.getElementById('removeStudentBtn')
      },
      fields:{
        name:document.getElementById('studentName'),
        dob:document.getElementById('dob'),
        adm:document.getElementById('admissionNo'),
        klass:document.getElementById('klass'),
        gender:document.getElementById('gender'),
        validForYears:document.getElementById('validForYears'),
        showGender:document.getElementById('showGender'),
        photoUrl:document.getElementById('photoUrl'),
        photoFile:document.getElementById('photoFile'),
        phone:document.getElementById('phone'),
        email:document.getElementById('email'),
        address:document.getElementById('address'),
        studentSelect:document.getElementById('studentSelect')
      },
      errors:{
        name:document.getElementById('errName'),
        dob:document.getElementById('errDob'),
        adm:document.getElementById('errAdm'),
        klass:document.getElementById('errClass'),
        gender:document.getElementById('errGender'),
        photo:document.getElementById('errPhoto')
      }
    };

    let students=[{
      name:'ADEKUNLE SAMUEL',
      dob:'',
      adm:'GLC/2025/001',
      klass:'SS1 A',
      gender:'Male',
      showGender:true,
      validForYears:1,
      validUntil:futureDate(1),
      photo:CONFIG.defaultPhoto,
      phone:'+234 801 123 4567',
      email:'info@greatlandmarkcollege.org',
      address:'45, Oke Alaro Rd, Abusoro, Akure'
    }];
    let idx=0;

    /* utils */
    function futureDate(years){
      const d=new Date(); d.setFullYear(d.getFullYear()+years);
      return d.toISOString().split('T')[0];
    }
    function sanitize(s){return String(s||'').replace(/[<>&"']/g,c=>'&#'+c.charCodeAt(0)+';')}
    function showErr(el,on,msg){if(!el)return; el.style.display=on?'block':'none'; if(msg) el.textContent=msg;}

    async function preload(src){return new Promise((res,rej)=>{const i=new Image(); i.crossOrigin='anonymous'; i.onload=()=>res(); i.onerror=()=>rej(); i.src=src;});}

    /* photo handling */
    async function fileToDataUrl(file){return new Promise((res,rej)=>{const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file);});}
    async function resizeImage(file,max=360){
      const data=await fileToDataUrl(file);
      const img=new Image(); img.src=data;
      return new Promise(resolve=>{
        img.onload=()=>{
          const scale=Math.min(max/img.width,max/img.height,1);
          const c=document.createElement('canvas'); c.width=img.width*scale; c.height=img.height*scale;
          const x=c.getContext('2d'); x.drawImage(img,0,0,c.width,c.height);
          resolve(c.toDataURL('image/jpeg',0.82));
        };
        img.onerror=()=>resolve(CONFIG.defaultPhoto);
      });
    }

    /* state helpers */
    function updateSelect(){
      els.fields.studentSelect.innerHTML = students.map((s,i)=>`<option value="${i}">Student ${i+1}${s.name?`: ${s.name}`:''}</option>`).join('');
      els.fields.studentSelect.value = idx;
      els.tools.removeStudentBtn.disabled = students.length<=1;
      const per=Number(els.tools.cardsPerPage.value);
      const pages=Math.ceil(students.length/per);
      els.note.textContent = `${students.length} card${students.length!==1?'s':''} • ${per} per sheet • about ${pages} page${pages!==1?'s':''}.`;
    }

    function normalizeClass(s){
      // Remove accidental double spaces like "SS 1" -> "SS1"
      return s.replace(/\b([A-Za-z]+)\s+(\d)/g,'$1$2').replace(/\s+/g,' ').trim();
    }

    function loadForm(){
      const s=students[idx];
      els.fields.name.value=s.name||'';
      els.fields.dob.value=s.dob||'';
      els.fields.adm.value=s.adm||'';
      els.fields.klass.value=s.klass||'';
      els.fields.gender.value=s.gender||'Male';
      els.fields.validForYears.value=s.validForYears||1;
      els.fields.showGender.checked = s.showGender!==false;
      els.fields.photoUrl.value = (s.photo && s.photo.startsWith('http')) ? s.photo : '';
      els.fields.photoFile.value='';
      els.fields.phone.value=s.phone||'';
      els.fields.email.value=s.email||'';
      els.fields.address.value=s.address||'';
    }

    function readFormIntoState(){
      const s=students[idx];
      s.name = els.fields.name.value.trim();
      s.dob  = els.fields.dob.value;
      s.adm  = els.fields.adm.value.trim();
      s.klass= normalizeClass(els.fields.klass.value.trim());   // normalize spacing like “SS 1”
      s.gender= els.fields.gender.value;
      s.validForYears = parseInt(els.fields.validForYears.value||'1',10);
      s.validUntil = futureDate(s.validForYears);
      s.showGender = els.fields.showGender.checked;
      s.phone = els.fields.phone.value.trim();
      s.email = els.fields.email.value.trim();
      s.address = els.fields.address.value.trim();
    }

    /* validation */
    function validField(input,errEl,pattern){
      const v=input.value.trim();
      const ok = pattern ? new RegExp(pattern).test(v) : !!v;
      showErr(errEl,!ok);
      return ok;
    }

    /* render preview and print pages */
    async function updatePreview(){
      readFormIntoState();

      const ok = [
        validField(els.fields.name, els.errors.name),
        validField(els.fields.dob,  els.errors.dob),
        validField(els.fields.adm,  els.errors.adm, els.fields.adm.pattern),
        validField(els.fields.klass,els.errors.klass),
        validField(els.fields.gender,els.errors.gender)
      ].every(Boolean);

      const s=students[idx];

      // long name detection -> smaller font on the name row
      const isLongName = (s.name||'').length > 24;

      els.idStage.innerHTML = `
        <div class="id-card-wrapper">
          <div class="id-card-container" id="card-${idx}">
            <section class="face front" aria-hidden="false">
              <header class="id-card-header">
                <img class="logo" src="${CONFIG.defaultLogo}" alt="College Logo" loading="eager" crossorigin="anonymous"/>
                <h3>GREAT LANDMARK COLLEGE</h3>
              </header>

              <div class="body-front">
                <div class="photo">
                  <img src="${s.photo||CONFIG.defaultPhoto}" alt="Student Photo" crossorigin="anonymous" loading="lazy">
                </div>
                <div class="details">
                  <h4>STUDENT IDENTITY CARD</h4>
                  <p class="kv name ${isLongName?'long':''}"><strong>Student Name:</strong> <span>${sanitize(s.name) || '—'}</span></p>
                  <p class="kv"><strong>Admission No:</strong> <span>${(s.adm||'').match(els.fields.adm.pattern)?s.adm:'—'}</span></p>
                  <p class="kv"><strong>DOB:</strong> <span>${s.dob||'—'}</span></p>
                  <p class="kv"><strong>Class:</strong> <span>${sanitize(s.klass)||'—'}</span></p>
                  ${s.showGender?`<p class="kv"><strong>Gender:</strong> <span>${sanitize(s.gender)}</span></p>`:''}
                </div>
              </div>

              <footer class="footer">IMPORTANT. This card is property of Great Landmark College. If found, return to the school. Misuse is prohibited.</footer>
            </section>

            <section class="face back" aria-hidden="true">
              <header class="id-card-header">
                <img class="logo" src="${CONFIG.defaultLogo}" alt="College Logo" loading="eager" crossorigin="anonymous"/>
                <h3>GREAT LANDMARK COLLEGE</h3>
              </header>
              <div class="body-back" style="padding:6mm;text-align:center">
                <div class="meta" style="font-size:3.2mm;line-height:1.3">
                  <div class="title" style="font-weight:800;margin-bottom:1mm">Valid Until: ${s.validUntil}</div>
                  <div>Address: ${sanitize(s.address)||'—'}</div>
                  <div>Phone: ${sanitize(s.phone)||'—'}</div>
                  <div>Email: ${sanitize(s.email)||'—'}</div>
                  <div>Website: www.greatlandmarkcollege.org</div>
                </div>
              </div>
              <footer class="footer">IMPORTANT. If found, return to Great Landmark College. Alteration or misuse may lead to disciplinary action.</footer>
            </section>
          </div>
        </div>
      `;

      await buildPrintPages();

      return ok;
    }

    async function buildPrintPages(){
      const per = Number(els.tools.cardsPerPage.value); // 4 or 8
      const useImages = els.tools.imageMode.checked;

      els.printPages.innerHTML='';
      const cols = 2;
      const rows = per/cols;           // 2 or 4
      const gap  = per===8 ? '6mm' : '10mm';

      // If rendering to images, pre-render each face to PNG for rock-solid printer output
      let data = null;
      if(useImages){
        data = await renderAllToImages();
      }

      for(let i=0;i<students.length;i+=per){
        const pageStudents = students.slice(i,i+per);
        const page = document.createElement('div');
        page.className='print-page';

        // front
        const front = document.createElement('div');
        front.className='grid-surface front-surface';
        front.style.gridTemplateColumns = `repeat(${cols}, var(--card-w))`;
        front.style.gridTemplateRows    = `repeat(${rows}, var(--card-h))`;
        front.style.gap = gap;

        // back
        const back = document.createElement('div');
        back.className='grid-surface back-surface';
        back.style.gridTemplateColumns = `repeat(${cols}, var(--card-w))`;
        back.style.gridTemplateRows    = `repeat(${rows}, var(--card-h))`;
        back.style.gap = gap;

        pageStudents.forEach((s,ix)=>{
          const gi = i+ix;

          if(useImages){
            const fw = document.createElement('div'); fw.className='id-card-wrapper print';
            fw.innerHTML = `<img src="${data[gi].front}" style="width:100%;height:100%;display:block"/>`;
            front.appendChild(fw);

            const bw = document.createElement('div'); bw.className='id-card-wrapper print';
            bw.innerHTML = `<img src="${data[gi].back}" style="width:100%;height:100%;display:block"/>`;
            back.appendChild(bw);
          }else{
            // HTML version for crisp vector text
            front.appendChild(htmlFrontCard(s));
            back.appendChild(htmlBackCard(s));
          }
        });

        page.appendChild(front);
        page.appendChild(back);
        els.printPages.appendChild(page);
      }
    }

    function htmlFrontCard(s){
      const isLong = (s.name||'').length>24;
      const wrap = document.createElement('div'); wrap.className='id-card-wrapper print';
      wrap.innerHTML = `
        <div class="id-card-container">
          <section class="face print">
            <header class="id-card-header">
              <img class="logo" src="${CONFIG.defaultLogo}" alt="College Logo" crossorigin="anonymous"/>
              <h3>GREAT LANDMARK COLLEGE</h3>
            </header>
            <div class="body-front">
              <div class="photo"><img src="${s.photo||CONFIG.defaultPhoto}" alt="Student Photo" crossorigin="anonymous"></div>
              <div class="details">
                <h4>STUDENT IDENTITY CARD</h4>
                <p class="kv name ${isLong?'long':''}"><strong>Student Name:</strong> <span>${sanitize(s.name)||'—'}</span></p>
                <p class="kv"><strong>Admission No:</strong> <span>${(s.adm||'').match(els.fields.adm.pattern)?s.adm:'—'}</span></p>
                <p class="kv"><strong>DOB:</strong> <span>${s.dob||'—'}</span></p>
                <p class="kv"><strong>Class:</strong> <span>${sanitize(s.klass)||'—'}</span></p>
                ${s.showGender?`<p class="kv"><strong>Gender:</strong> <span>${sanitize(s.gender)}</span></p>`:''}
              </div>
            </div>
            <footer class="footer">IMPORTANT. This card is property of Great Landmark College. If found, return to the school. Misuse is prohibited.</footer>
          </section>
        </div>`;
      return wrap;
    }

    function htmlBackCard(s){
      const wrap = document.createElement('div'); wrap.className='id-card-wrapper print';
      wrap.innerHTML = `
        <div class="id-card-container">
          <section class="face print">
            <header class="id-card-header">
              <img class="logo" src="${CONFIG.defaultLogo}" alt="College Logo" crossorigin="anonymous"/>
              <h3>GREAT LANDMARK COLLEGE</h3>
            </header>
            <div class="body-back" style="padding:6mm;text-align:center">
              <div class="meta" style="font-size:3.2mm;line-height:1.3">
                <div class="title" style="font-weight:800;margin-bottom:1mm">Valid Until: ${s.validUntil}</div>
                <div>Address: ${sanitize(s.address)||'—'}</div>
                <div>Phone: ${sanitize(s.phone)||'—'}</div>
                <div>Email: ${sanitize(s.email)||'—'}</div>
                <div>Website: www.greatlandmarkcollege.org</div>
              </div>
            </div>
            <footer class="footer">IMPORTANT. If found, return to Great Landmark College. Alteration or misuse may lead to disciplinary action.</footer>
          </section>
        </div>`;
      return wrap;
    }

    async function renderAllToImages(){
      els.loading.classList.add('active');

      // build a hidden single-card surface we can snapshot
      const tmp=document.createElement('div');
      tmp.style.position='absolute'; tmp.style.left='-9999px';
      tmp.style.width='var(--card-w)'; tmp.style.height='var(--card-h)';
      document.body.appendChild(tmp);

      const out=[];
      for(let i=0;i<students.length;i++){
        const s=students[i];
        tmp.innerHTML=''; tmp.appendChild(htmlFrontCard(s));
        await document.fonts.ready;
        const front=await html2canvas(tmp.firstElementChild.querySelector('.face'),{scale:2,useCORS:true,backgroundColor:null}).then(c=>c.toDataURL('image/png'));

        tmp.innerHTML=''; tmp.appendChild(htmlBackCard(s));
        await document.fonts.ready;
        const back=await html2canvas(tmp.firstElementChild.querySelector('.face'),{scale:2,useCORS:true,backgroundColor:null}).then(c=>c.toDataURL('image/png'));

        out.push({front,back});
      }
      document.body.removeChild(tmp);
      els.loading.classList.remove('active');
      return out;
    }

    /* events */
    function bind(){
      // input changes
      els.form.addEventListener('input', async (e)=>{
        if(e.target===els.fields.photoUrl){
          // try to preload provided URL
          try{ if(els.fields.photoUrl.value){ await preload(els.fields.photoUrl.value); students[idx].photo=els.fields.photoUrl.value; } }
          catch{ showErr(els.errors.photo,true,'Failed to load photo URL.'); }
        }
        updatePreview();
      });

      els.fields.photoFile.addEventListener('change', async ()=>{
        const f=els.fields.photoFile.files?.[0];
        if(!f) return;
        const data=await resizeImage(f);
        students[idx].photo=data; els.fields.photoUrl.value='';
        updatePreview();
      });

      els.form.addEventListener('submit', (e)=>{e.preventDefault(); updatePreview();});

      els.tools.flipBtn.addEventListener('click', ()=>{
        const c=document.getElementById(`card-${idx}`);
        if(!c) return;
        c.classList.toggle('flipped');
        const isFlipped=c.classList.contains('flipped');
        c.querySelector('.front').setAttribute('aria-hidden',isFlipped);
        c.querySelector('.back').setAttribute('aria-hidden',!isFlipped);
      });

      els.tools.paperSize.addEventListener('change', (e)=>{
        if(e.target.value==='Letter'){
          document.documentElement.style.setProperty('--page-w','215.9mm');
          document.documentElement.style.setProperty('--page-h','279.4mm');
        }else{
          document.documentElement.style.setProperty('--page-w','210mm');
          document.documentElement.style.setProperty('--page-h','297mm');
        }
        buildPrintPages();
      });

      els.tools.duplexMode.addEventListener('change',(e)=>{
        document.documentElement.style.setProperty('--duplex-rotate', e.target.value==='long' ? '180deg' : '0deg');
      });

      els.tools.cardsPerPage.addEventListener('change', ()=>{updateSelect(); buildPrintPages();});
      els.tools.imageMode.addEventListener('change', ()=>buildPrintPages());

      document.getElementById('resetBtn').addEventListener('click', ()=>{localStorage.removeItem('glc_id_state'); location.reload();});

      // student add/remove/select
      document.getElementById('addStudentBtn').addEventListener('click', ()=>{
        students.push({
          name:'',dob:'',adm:'',klass:'',gender:'Male',showGender:true,
          validForYears:1,validUntil:futureDate(1),
          photo:CONFIG.defaultPhoto,phone:'',email:'',address:''
        });
        idx=students.length-1; loadForm(); updateSelect(); updatePreview();
      });

      document.getElementById('removeStudentBtn').addEventListener('click', ()=>{
        if(students.length<=1) return;
        students.splice(idx,1); idx=Math.max(0,idx-1);
        loadForm(); updateSelect(); updatePreview();
      });

      els.fields.studentSelect.addEventListener('change',(e)=>{idx=parseInt(e.target.value,10); loadForm(); updatePreview();});

      // print buttons (front/back toggle)
      document.getElementById('printFrontsBtn').addEventListener('click', ()=>{
        document.querySelectorAll('.print-page').forEach(p=>{
          p.querySelector('.front-surface').style.display='grid';
          p.querySelector('.back-surface').style.display='none';
        });
        window.print();
      });

      document.getElementById('printBacksBtn').addEventListener('click', ()=>{
        document.querySelectorAll('.print-page').forEach(p=>{
          p.querySelector('.front-surface').style.display='none';
          p.querySelector('.back-surface').style.display='grid';
        });
        window.print();
      });
    }

    /* boot */
    (async function init(){
      // default DOB sample so the field shows something
      students[0].dob = '';
      // restore saved if present
      try{
        const raw=localStorage.getItem('glc_id_state_v2');
        if(raw){
          const data=JSON.parse(raw);
          students=data.students||students; idx=Math.min(data.idx||0, students.length-1);
        }
      }catch{}

      bind();
      updateSelect();
      loadForm();
      try{ await preload(CONFIG.defaultLogo);}catch{}
      updatePreview();

      // autosave
      setInterval(()=>{ localStorage.setItem('glc_id_state_v2', JSON.stringify({students,idx})); }, 1500);
    })();
  })();
  </script>
</body>
</html>
