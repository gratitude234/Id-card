<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ID Card Generator — Great Landmark College</title>

  <!-- QR + html2canvas (CDNs) -->
  <script src="https://cdn.jsdelivr.net/npm/easyqrcodejs@4.4.10/dist/easy.qrcode.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">

  <style>
    :root {
      --blue: #0d2f6f;
      --yellow: #f9a825;
      --red: #e54c4c;
      --bg: #f4f7f6;
      --ink: #333;
      --border-radius: 10px;
      --padding-sm: 16px;
      --shadow: 0 4px 12px rgba(0,0,0,.1);
      --focus: #5b9dd9;
      --page-w: 210mm;   /* default A4 */
      --page-h: 297mm;
      --bottom-row-h: 20mm;
      --qr-size: 18mm;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Inter, Arial, sans-serif;
      background: var(--bg); padding: 16px; display: flex; flex-direction: column; align-items: center; color: var(--ink);
    }

    .container {
      background: #fff; padding: 20px; border-radius: var(--border-radius); box-shadow: var(--shadow);
      max-width: 960px; width: 100%; margin-bottom: 20px;
    }
    h1 { text-align: center; color: var(--blue); margin: 0 0 16px; font-size: 26px; font-weight: 700; }
    h2 { color: var(--blue); border-bottom: 2px solid #eee; padding-bottom: 8px; margin: 16px 0; font-size: 20px; }

    /* Form */
    .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 12px; }
    .col-6 { grid-column: span 6; }
    .col-12 { grid-column: span 12; }

    .form-group { position: relative; display: flex; flex-direction: column; gap: 6px; }
    .form-group label { font-weight: 600; color: #444; font-size: 14px; }
    .form-group input[type="text"],
    .form-group input[type="date"],
    .form-group input[type="url"],
    .form-group input[type="email"],
    .form-group select {
      padding: var(--padding-sm); border: 1px solid #ddd; border-radius: var(--border-radius);
      font-size: 16px; background: #fff; transition: border-color 0.2s ease;
    }
    .form-group input:focus,
    .form-group select:focus { outline: 2px solid var(--focus); border-color: var(--focus); }
    .form-group.valid::after {
      content: '✔'; position: absolute; right: 12px; top: 36px; color: #2ecc71; font-size: 16px;
    }
    .form-group.invalid::after {
      content: '✘'; position: absolute; right: 12px; top: 36px; color: #b00020; font-size: 16px;
    }
    .form-group.valid input, .form-group.valid select { border-color: #2ecc71; }
    .form-group.invalid input, .form-group.invalid select { border-color: #b00020; }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .help-text { font-size: 12px; color: #777; }
    .error-text { font-size: 12px; color: #b00020; display: none; margin-top: 4px; }
    .loading {
      display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.8); color: #fff; padding: 12px 24px; border-radius: 8px; z-index: 1000; font-size: 16px;
    }
    .loading.active { display: flex; align-items: center; gap: 8px; }
    .loading::before { content: '⏳'; }

    .btn {
      background: var(--blue); color: #fff; padding: 14px 20px; border: 0; border-radius: var(--border-radius);
      cursor: pointer; font-size: 16px; font-weight: 600; transition: transform 0.1s ease, background 0.2s ease;
      min-height: 48px; touch-action: manipulation;
    }
    .btn:hover { background: #1e3a8a; transform: scale(1.02); }
    .btn:active { transform: scale(0.98); }
    .btn.secondary { background: #eef2ff; color: #1e2a78; border: 1px solid #dfe3ff; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Student Controls */
    .student-controls { display: flex; flex-direction: row; gap: 10px; align-items: center; margin-bottom: 16px; }
    .student-controls select { flex: 1; }

    /* Card area */
    .tools { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin: 12px 0; }

    .id-stage { display: flex; gap: 18px; justify-content: center; flex-wrap: wrap; }
    .id-card-wrapper {
      width: 350px; aspect-ratio: 85.6 / 54; position: relative;
      perspective: 1000px; margin: 12px auto 0; transition: transform 0.3s ease;
    }
    .id-card-container {
      position: absolute; inset: 0; transform-style: preserve-3d;
      transition: transform 0.7s cubic-bezier(0.68, -0.55, 0.27, 1.55), scale 0.2s ease;
    }
    .id-card-container:hover { scale: 1.02; }
    .id-card-container.flipped { transform: rotateY(180deg); }

    .face {
      position: absolute; inset: 0; backface-visibility: hidden; border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,.18); background: #fff;
      display: grid;
      grid-template-rows: 40px 1fr auto;  /* header | body | footer */
      overflow: hidden; color: #333;
      outline: 2px solid transparent;
    }
    .face:focus { outline: 2px solid var(--focus); outline-offset: 3px; }
    .back { transform: rotateY(180deg); }

    .id-card-header {
      background: var(--blue); color: #fff; padding: 8px 14px; display: flex;
      align-items: center; height: 40px; border-bottom: 3px solid var(--yellow);
    }
    .logo { height: 28px; width: 28px; margin-right: 10px; background: #fff; border-radius: 50%; object-fit: cover; }
    .id-card-header img {
      width: 28px !important;
      height: 28px !important;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 10px;
      background: #fff;
    }
    .id-card-header h3 { font-size: 15px; margin: 0; font-weight: 800; letter-spacing: .3px; }

    .body-front { display: flex; padding: 12px; gap: 12px; flex-grow: 1; align-items: flex-start; }
    .photo { width: 74px; height: 74px; border-radius: 8px; overflow: hidden; border: 2px solid var(--yellow); flex-shrink: 0; }
    .photo img { width: 100%; height: 100%; object-fit: cover; }

    .details { flex: 1; min-width: 0; }
    .details h4 { font-size: 13px; color: var(--blue); margin: 0 0 6px; border-bottom: 1px solid #eee; padding-bottom: 4px; font-weight: 800; }
    .kv { font-size: 11px; margin: 3px 0; line-height: 1.35; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .kv strong { color: var(--blue); display: inline-block; min-width: 90px; }

    .body-back{
      grid-row: 2;
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: auto 1fr var(--bottom-row-h);
      gap: 2mm 4mm;
      padding: 6mm 6mm 5mm;
      overflow: hidden;
    }
    .meta{
      grid-column: 1 / -1;
      text-align: center;
      font-size: 3.2mm;
      line-height: 1.3;
      margin: 0;                                  /* keep compact */
    }
    .meta .title{ font-weight: 800; margin-bottom: 1mm; }

    .qr{
      grid-column: 1; grid-row: 3;
      justify-self: start;
      width: var(--qr-size); height: var(--qr-size);
      border: .3mm solid #ddd; border-radius: 1.5mm;
      display:flex; align-items:center; justify-content:center;
      overflow: hidden;
    }
    .qr canvas{ width:100% !important; height:100% !important; }

    .sign{
      grid-column: 2; grid-row: 3;
      place-self: end end;
      text-align: right;
      display:flex; flex-direction:column;
      align-items:flex-end; justify-content:flex-end;
      gap: 2mm;
      font-size: 3mm; line-height: 1.2;
      max-width: 40mm;
      max-height: var(--bottom-row-h);
      overflow: hidden;
    }
    .sign p{ margin: 0 0 1mm 0; }

    .sign .sig{
      font-family:"Great Vibes",cursive;
      font-weight:400;
      /* reserves ~8mm for caption + gaps + line */
      font-size:clamp(5mm, calc(var(--bottom-row-h) - 8mm), 9mm);
      line-height:1;
      white-space:nowrap;
      transform:translateY(0.5mm);
      max-width:34mm;
      max-height:calc(var(--bottom-row-h) - 8mm);
      overflow:hidden;
      text-overflow:ellipsis;
      border:0; background:transparent;
    }

    .sig-img{ max-height:calc(var(--bottom-row-h) - 8mm); width:auto; object-fit:contain; }

    .sign .line{
      width: 34mm;
      border-top: .3mm solid #cbd5e1;
    }

    .footer { background: var(--red); color: #fff; font-size: 9px; padding: 6px 10px; text-align: center; font-weight: 700; }

    .print-page { display: none; width: var(--page-w); height: var(--page-h); }
    .front-grid, .back-grid {
      position: absolute; top: 0; left: 0; width: var(--page-w); height: var(--page-h);
      display: grid; grid-template-columns: repeat(2, 85.6mm); grid-template-rows: repeat(2, 54mm);
      gap: 10mm; justify-content: center; align-content: start;
    }
    .back-grid { transform: rotate(180deg); } /* Align backs for long-edge duplex */
    .id-card-wrapper { width: 85.6mm; height: 54mm; }
    .id-card-container { transform: none; }
    .face { width: 85.6mm; height: 54mm; box-shadow: none; border-radius: 2mm; border: 1px dashed #ccc; }

    @media print {
      @page { size: auto; margin: 0; }

      html, body, * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        forced-color-adjust: none !important;
      }

      body { background:#fff; padding:0; margin:0; }
      .container { box-shadow:none; padding:0; }
      .id-stage, .tools, .form-section, .notes, .loading { display:none !important; }
      h1, h2 { display:none !important; }

      .print-page { display:block; position:relative; width:var(--page-w); height:var(--page-h); page-break-after:always; }
      .front-grid { display:grid; }
      .back-grid  { display:none; }
      .print-page.print-back .front-grid { display:none; }
      .print-page.print-back .back-grid  { display:grid; }

      .id-card-header {
        background-color: var(--blue) !important;
        color:#fff !important;
        border-bottom-color: var(--yellow) !important;
      }
      .footer {
        background-color: var(--red) !important;
        color:#fff !important;
      }
    }

    @media (max-width: 768px) {
      body { padding: 12px; }
      .container { padding: 16px; box-shadow: var(--shadow); }
      h1 { font-size: 24px; }
      h2 { font-size: 18px; }
      .grid { grid-template-columns: 1fr; gap: 10px; }
      .col-6, .col-12 { grid-column: span 1; }
      .student-controls { flex-direction: column; gap: 8px; }
      .tools { flex-direction: column; }
      .btn { width: 100%; min-height: 50px; font-size: 16px; }
      .id-card-wrapper { width: 90%; max-width: 320px; margin: 10px auto; }
      .id-stage { justify-content: center; }
      .notes { font-size: 13px; text-align: left; }
      .error-text { font-size: 13px; }
      .help-text { font-size: 13px; }
      .form-group label { font-size: 14px; }
      .form-group input, .form-group select { font-size: 16px; padding: 14px; }
      .id-card-header h3 { font-size: 14px; }
      .kv { font-size: 10px; }
      .footer { font-size: 8px; }
      .meta { font-size: 10px; }
      .qr { width: 50px; height: 50px; }
      .sign { font-size: 10px; }
      .sign .sig { max-height: 30px; }
      .sign .line { width: 80px; }
    }

    @media (max-width: 480px) {
      .id-card-wrapper { width: 100%; }
      .kv strong { min-width: 80px; }
      .photo { width: 60px; height: 60px; }
      .qr { width: 50px; height: 50px; }
      .sign { font-size: 10px; }
      .sign .sig { max-height: 30px; }
      .sign .line { width: 80px; }
    }

    .notes { font-size: 12px; color: #666; text-align: center; margin-top: 8px; }
  </style>
</head>
<body>
  <div class="container" aria-live="polite">
    <h1>Great Landmark College ID Card Generator</h1>

    <!-- FORM -->
    <div class="form-section">
      <h2>Enter Student Details</h2>
      <div class="student-controls">
        <div class="form-group">
          <label for="studentSelect">Select Student</label>
          <select id="studentSelect" aria-describedby="errStudentSelect">
            <option value="0">Student 1</option>
          </select>
          <div class="error-text" id="errStudentSelect" aria-live="assertive"></div>
        </div>
        <button class="btn secondary" id="addStudentBtn" type="button">Add Student</button>
        <button class="btn secondary" id="removeStudentBtn" type="button" disabled>Remove Selected</button>
      </div>
      <form id="form" novalidate>
        <div class="grid">
          <div class="col-6">
            <div class="form-group">
              <label for="studentName">Student Name</label>
              <input id="studentName" type="text" required value="ADEKUNLE SAMUEL" autocomplete="name" aria-describedby="errName" />
              <div class="error-text" id="errName" aria-live="assertive">Please enter a name.</div>
            </div>
          </div>

          <div class="col-6">
            <div class="form-group">
              <label for="admissionNo">Admission No</label>
              <input id="admissionNo" type="text" required placeholder="e.g., GLC/2025/001"
                     pattern="^[A-Za-z]{3}\/\d{4}\/\d{3}$" value="GLC/2025/001" aria-describedby="errAdm" />
              <div class="error-text" id="errAdm" aria-live="assertive">Use format GLC/2025/001.</div>
            </div>
          </div>

          <div class="col-6">
            <div class="form-group">
              <label for="klass">Class</label>
              <input id="klass" type="text" required value="SS1 A" aria-describedby="errClass" />
              <div class="error-text" id="errClass" aria-live="assertive">Please enter a class.</div>
            </div>
          </div>

          <div class="col-6">
            <div class="form-group">
              <label for="dob">Date of Birth</label>
              <input id="dob" type="date" required value="2009-09-15" aria-describedby="errDob" />
              <div class="error-text" id="errDob" aria-live="assertive">Please select a valid date.</div>
            </div>
          </div>

          <div class="col-6">
            <div class="form-group">
              <label for="validForYears">Valid For</label>
              <select id="validForYears">
                <option value="1">1 year</option>
                <option value="2">2 years</option>
                <option value="3">3 years</option>
                <option value="4">4 years</option>
                <option value="5">5 years</option>
              </select>
            </div>
          </div>

          <div class="col-6">
            <div class="form-group">
              <label for="director">Director’s Name (for signature)</label>
              <input id="director" type="text" required value="OLANIBI GREAT-GOD" aria-describedby="errDir" />
              <div class="error-text" id="errDir" aria-live="assertive">Please enter a name.</div>
            </div>
          </div>

          <div class="col-12">
            <div class="form-group">
              <label for="signatureUrl">Signature Image URL (optional)</label>
              <input id="signatureUrl" type="url" placeholder="https://example.com/signature.png" />
              <div class="row">
                <input id="signatureFile" type="file" accept="image/*" />
                <span class="help-text">If provided, image overrides the text signature.</span>
              </div>
            </div>
          </div>

          <div class="col-12">
            <div class="form-group">
              <label for="showDob">
                <input type="checkbox" id="showDob" checked> Show Date of Birth on card
              </label>
            </div>
          </div>

          <div class="col-12">
            <div class="form-group">
              <label for="photoUrl">Student Photo URL</label>
              <input id="photoUrl" type="url" placeholder="https://example.com/photo.jpg"
                     value="https://via.placeholder.com/300x300?text=Student" aria-describedby="errPhoto" />
              <div class="row">
                <input id="photoFile" type="file" accept="image/*,image/heic,image/heif" />
                <span class="help-text">Upload overrides URL. Large images are scaled.</span>
              </div>
              <div class="error-text" id="errPhoto" aria-live="assertive"></div>
            </div>
          </div>

          <div class="col-6">
            <div class="form-group">
              <label for="phone">Phone</label>
              <input id="phone" type="text" value="+234 801 123 4567" />
            </div>
          </div>

          <div class="col-6">
            <div class="form-group">
              <label for="email">Email</label>
              <input id="email" type="email" value="info@greatlandmarkcollege.org" />
            </div>
          </div>

          <div class="col-12">
            <div class="form-group">
              <label for="address">Address</label>
              <input id="address" type="text" value="45, Oke Alaro Rd, Abusoro, Akure" />
            </div>
          </div>

          <div class="col-12">
            <div class="row">
              <button class="btn" type="submit">Update Preview</button>
              <button class="btn secondary" type="button" id="resetBtn">Reset to Defaults</button>
            </div>
          </div>
        </div>
      </form>
      <div class="loading">Processing...</div>
    </div>

    <!-- OUTPUT -->
    <h2>Generated ID Card (Current Student)</h2>
    <div class="tools">
      <button class="btn secondary" id="flipBtn" type="button">Flip</button>
      <button class="btn secondary" id="printFrontsBtn" type="button">Print Fronts</button>
      <button class="btn secondary" id="printBacksBtn" type="button">Print Backs</button>
      <label for="imageMode" style="display: flex; align-items: center; font-size: 14px; color: #444;">
        <input type="checkbox" id="imageMode"> Render as images (fixes missing colors on some printers)
      </label>
      <label class="btn secondary" style="display:inline-flex;gap:.5rem;align-items:center">
        Paper size
        <select id="paperSize">
          <option value="A4">A4</option>
          <option value="Letter">Letter</option>
        </select>
      </label>
    </div>

    <div class="id-stage" id="idStage">
      <!-- Single card preview -->
    </div>

    <div id="printPages" aria-hidden="true">
      <!-- Dynamically populated for printing -->
    </div>

    <p class="notes" id="pageCount">Tip: Add students and use <b>Print Fronts</b> and <b>Print Backs</b> to print fronts and backs on the same A4 sheets (4 cards per sheet, 85.6 mm × 54 mm). For non-duplex printers, print fronts, flip the paper (long edge), and print again.</p>
  </div>

  <script>
    (function () {
      const CONFIG = {
        defaultPhoto: 'https://via.placeholder.com/300x300?text=Student',
        defaultLogo: '/glc-logo.jpg',
        qrSize: 66,
        captureScale: 2,
        debounceDelay: 300,
        cardsPerPage: 4
      };

      // Elements
      const elements = {
        form: document.getElementById('form'),
        fields: {
          name: document.getElementById('studentName'),
          adm: document.getElementById('admissionNo'),
          klass: document.getElementById('klass'),
          dob: document.getElementById('dob'),
          validForYears: document.getElementById('validForYears'),
          director: document.getElementById('director'),
          showDob: document.getElementById('showDob'),
          signatureUrl: document.getElementById('signatureUrl'),
          signatureFile: document.getElementById('signatureFile'),
          photoUrl: document.getElementById('photoUrl'),
          photoFile: document.getElementById('photoFile'),
          phone: document.getElementById('phone'),
          email: document.getElementById('email'),
          address: document.getElementById('address'),
          studentSelect: document.getElementById('studentSelect')
        },
        errors: {
          name: document.getElementById('errName'),
          adm: document.getElementById('errAdm'),
          klass: document.getElementById('errClass'),
          dob: document.getElementById('errDob'),
          director: document.getElementById('errDir'),
          studentSelect: document.getElementById('errStudentSelect')
        },
        tools: {
          flipBtn: document.getElementById('flipBtn'),
          printFrontsBtn: document.getElementById('printFrontsBtn'),
          printBacksBtn: document.getElementById('printBacksBtn'),
          imageMode: document.getElementById('imageMode'),
          resetBtn: document.getElementById('resetBtn'),
          addStudentBtn: document.getElementById('addStudentBtn'),
          removeStudentBtn: document.getElementById('removeStudentBtn')
        },
        idStage: document.getElementById('idStage'),
        printPages: document.getElementById('printPages'),
        pageCount: document.getElementById('pageCount'),
        loading: document.querySelector('.loading')
      };

      let students = [{
        name: 'ADEKUNLE SAMUEL',
        adm: 'GLC/2025/001',
        klass: 'SS1 A',
        dob: '2009-09-15',
        validForYears: 1,
        valid: '2026-09-28',
        director: 'OLANIBI GREAT-GOD',
        showDob: true,
        signatureImg: null,
        photo: CONFIG.defaultPhoto,
        phone: '+234 801 123 4567',
        email: 'info@greatlandmarkcollege.org',
        address: '45, Oke Alaro Rd, Abusoro, Akure'
      }];
      let currentStudentIndex = 0;
      let qrInstances = [];
      let debounceTimer;
      const cardCaches = [];

      // Utilities
      const utils = {
        pad: n => n.toString().padStart(2, '0'),
        fmtDate(iso) {
          if (!iso) return '—';
          const d = new Date(iso);
          return Number.isNaN(d.getTime()) ? '—' : `${this.pad(d.getDate())}/${this.pad(d.getMonth() + 1)}/${d.getFullYear()}`;
        },
        sanitize(str) {
          return str.replace(/[<>&"']/g, c => `&#${c.charCodeAt(0)};`);
        },
        showErr(el, show, msg) {
          el.style.display = show ? 'block' : 'none';
          if (msg) el.textContent = msg;
        },
        isSafeUrl(url) {
          return url.startsWith('https://') && url.match(/\.(jpg|jpeg|png|gif|webp)$/i);
        },
        preloadImage(url) {
          return new Promise((resolve, reject) => {
            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.src = url;
            img.onload = () => resolve(url);
            img.onerror = () => reject(new Error('Failed to load image'));
          });
        }
      };

      function computeValidDate(years) {
        const today = new Date();
        const valid = new Date(today);
        valid.setFullYear(today.getFullYear() + years);
        return valid.toISOString().split('T')[0];
      }

      // State Management
      const state = {
        save() {
          try {
            const data = { students, currentStudentIndex };
            const serialized = JSON.stringify(data);
            if (serialized.length > 4 * 1024 * 1024) { // Warn at ~4MB
              alert('Warning: Data is large and may exceed storage limits. Consider exporting or removing some students.');
            }
            localStorage.setItem('glc_id_state', serialized);
          } catch (err) {
            console.error('Failed to save state:', err);
            alert('Failed to save data. Storage may be full.');
          }
        },
        load() {
          try {
            const raw = localStorage.getItem('glc_id_state');
            if (!raw) return;
            const s = JSON.parse(raw);
            students = s.students || students;
            currentStudentIndex = Math.min(s.currentStudentIndex || 0, students.length - 1);
            cardCaches.length = 0;
            students.forEach(() => cardCaches.push({ frontCache: null, backCache: null }));
            this.updateForm();
            this.updateStudentSelect();
          } catch (err) {
            console.error('Failed to load state:', err);
          }
        },
        updateForm() {
          const student = students[currentStudentIndex] || {};
          Object.entries(elements.fields).forEach(([k, el]) => {
            if (k === 'showDob') {
              el.checked = student.showDob !== false; // default true
            } else if (k === 'signatureUrl') {
              el.value = student.signatureImg && student.signatureImg.startsWith('https://') ? student.signatureImg : '';
            } else if (k !== 'studentSelect' && k !== 'photoFile' && k !== 'signatureFile') {
              el.value = student[k] || '';
            }
          });
          elements.fields.photoFile.value = '';
          elements.fields.signatureFile.value = '';
        },
        updateStudentSelect() {
          elements.fields.studentSelect.innerHTML = students.map((s, i) => 
            `<option value="${i}">Student ${i + 1}${s.name ? `: ${s.name}` : ''}</option>`
          ).join('');
          elements.fields.studentSelect.value = currentStudentIndex;
          elements.tools.removeStudentBtn.disabled = students.length <= 1;
        },
        updatePageCount() {
          const pageCount = Math.ceil(students.length / CONFIG.cardsPerPage);
          elements.pageCount.textContent = `Tip: ${students.length} card${students.length !== 1 ? 's' : ''} will print on ${pageCount} A4 sheet${pageCount !== 1 ? 's' : ''} (4 cards per sheet, 85.6 mm × 54 mm, duplex: fronts on one side, backs on the other). For non-duplex printers, print fronts, flip the paper (long edge), and print again.`;
        }
      };

      // Photo Handling
      const photo = {
        async fileToDataUrl(file) {
          return new Promise((res, rej) => {
            const reader = new FileReader();
            reader.onload = () => res(reader.result);
            reader.onerror = rej;
            reader.readAsDataURL(file);
          });
        },
        async resizeImage(file, maxSize = 300) {
          const img = new Image();
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          img.src = await this.fileToDataUrl(file);
          return new Promise(resolve => {
            img.onload = () => {
              const scale = Math.min(maxSize / img.width, maxSize / img.height, 1);
              canvas.width = img.width * scale;
              canvas.height = img.height * scale;
              ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
              resolve(canvas.toDataURL('image/jpeg', 0.8));
            };
            img.onerror = () => resolve(CONFIG.defaultPhoto);
          });
        },
        async setPhoto() {
          elements.loading.classList.add('active');
          utils.showErr(elements.errors.photo, false);
          try {
            const file = elements.fields.photoFile.files?.[0];
            if (file) {
              const dataUrl = await this.resizeImage(file);
              students[currentStudentIndex].photo = dataUrl;
              elements.fields.photoUrl.value = '';
              return dataUrl;
            }
            const url = elements.fields.photoUrl.value.trim();
            if (url && utils.isSafeUrl(url)) {
              await utils.preloadImage(url);
              students[currentStudentIndex].photo = url;
              return url;
            }
            students[currentStudentIndex].photo = CONFIG.defaultPhoto;
            return CONFIG.defaultPhoto;
          } catch (err) {
            console.error('Photo processing error:', err);
            utils.showErr(elements.errors.photo, true, 'Failed to process image.');
            students[currentStudentIndex].photo = CONFIG.defaultPhoto;
            return CONFIG.defaultPhoto;
          } finally {
            elements.loading.classList.remove('active');
          }
        },
        async preloadLogos() {
          try {
            await utils.preloadImage(CONFIG.defaultLogo);
          } catch (err) {
            console.error('Failed to preload logos:', err);
          }
        }
      };

      // Signature Handling
      const signature = {
        async setSignature() {
          elements.loading.classList.add('active');
          try {
            const file = elements.fields.signatureFile.files?.[0];
            if (file) {
              const dataUrl = await photo.resizeImage(file, 500);
              students[currentStudentIndex].signatureImg = dataUrl;
              elements.fields.signatureUrl.value = '';
              return dataUrl;
            }
            const url = elements.fields.signatureUrl.value.trim();
            if (url && utils.isSafeUrl(url)) {
              await utils.preloadImage(url);
              students[currentStudentIndex].signatureImg = url;
              return url;
            }
            students[currentStudentIndex].signatureImg = null;
            return null;
          } catch (err) {
            console.error('Signature processing error:', err);
            students[currentStudentIndex].signatureImg = null;
            return null;
          } finally {
            elements.loading.classList.remove('active');
          }
        }
      };

      // QR Code
      const qr = {
        render(index) {
          const student = students[index] || {};
          let text = `Name: ${student.name || '-'}\nID: ${student.adm || '-'}\nValid Until: ${utils.fmtDate(student.valid)}\nWeb: www.greatlandmarkcollege.org`;
          if (student.showDob) {
            text += `\nDate of Birth: ${utils.fmtDate(student.dob)}`;
          }
          const qrWraps = [
            document.querySelector(`#qr-${index}`),
            document.querySelector(`#print-qr-${index}`)
          ].filter(Boolean);
          qrWraps.forEach(qrWrap => {
            qrWrap.innerHTML = '';
            if (window.QRCode) {
              qrInstances[index] = new QRCode(qrWrap, {
                text,
                width: CONFIG.qrSize,
                height: CONFIG.qrSize,
                colorDark: "#000",
                colorLight: "#fff",
                correctLevel: QRCode.CorrectLevel.H
              });
            }
          });
        }
      };

      // Form Validation and Preview
      const form = {
        validateField(field, errorEl, pattern = null) {
          const value = field.value.trim();
          const isValid = pattern ? new RegExp(pattern).test(value) : !!value;
          utils.showErr(errorEl, !isValid);
          field.parentElement.classList.toggle('valid', isValid);
          field.parentElement.classList.toggle('invalid', !isValid);
          return isValid;
        },
        validateDates() {
          const dob = new Date(elements.fields.dob.value);
          const valid = new Date(students[currentStudentIndex].valid);
          if (dob >= valid) {
            alert('Valid Until must be after Date of Birth.');
            return false;
          }
          return true;
        },
        updateStudentData() {
          students[currentStudentIndex] = {
            name: elements.fields.name.value,
            adm: elements.fields.adm.value,
            klass: elements.fields.klass.value,
            dob: elements.fields.dob.value,
            validForYears: parseInt(elements.fields.validForYears.value),
            director: elements.fields.director.value,
            showDob: elements.fields.showDob.checked,
            signatureImg: students[currentStudentIndex]?.signatureImg || null,
            photo: students[currentStudentIndex]?.photo || CONFIG.defaultPhoto,
            phone: elements.fields.phone.value,
            email: elements.fields.email.value,
            address: elements.fields.address.value
          };
          students[currentStudentIndex].valid = computeValidDate(students[currentStudentIndex].validForYears);
        },
        async updatePreview() {
          this.updateStudentData();
          const isValid = [
            this.validateField(elements.fields.name, elements.errors.name),
            this.validateField(elements.fields.adm, elements.errors.adm, elements.fields.adm.pattern),
            this.validateField(elements.fields.klass, elements.errors.klass),
            this.validateField(elements.fields.dob, elements.errors.dob),
            this.validateField(elements.fields.director, elements.errors.director),
            this.validateDates()
          ].every(Boolean);

          // Preview only the current student
          elements.idStage.innerHTML = '';
          const student = students[currentStudentIndex];
          let dobHtml = '';
          if (student.showDob) {
            dobHtml = `<p class="kv"><strong>Date of Birth:</strong> <span>${utils.fmtDate(student.dob)}</span></p>`;
          }
          elements.idStage.insertAdjacentHTML('beforeend', `
            <div class="id-card-wrapper" aria-label="ID card preview">
              <div class="id-card-container" id="card-${currentStudentIndex}">
                <section class="face front" tabindex="0" aria-label="Front of ID card" aria-hidden="false">
                  <header class="id-card-header">
                    <img class="logo" src="${CONFIG.defaultLogo}" alt="College Logo" crossorigin="anonymous" loading="eager" />
                    <h3>GREAT LANDMARK COLLEGE</h3>
                  </header>
                  <div class="body-front">
                    <div class="photo">
                      <img src="${student.photo}" alt="Student Photo" loading="lazy" crossorigin="anonymous">
                    </div>
                    <div class="details">
                      <h4>STUDENT IDENTITY CARD</h4>
                      <p class="kv"><strong>Student Name:</strong> <span>${utils.sanitize(student.name) || '—'}</span></p>
                      <p class="kv"><strong>Admission No:</strong> <span>${student.adm?.match(elements.fields.adm.pattern) ? student.adm : '—'}</span></p>
                      <p class="kv"><strong>Class:</strong> <span>${utils.sanitize(student.klass) || '—'}</span></p>
                      ${dobHtml}
                    </div>
                  </div>
                  <footer class="footer">
                    IMPORTANT. This card is property of Great Landmark College. If found, return to the school. Misuse is prohibited.
                  </footer>
                </section>
                <section class="face back" tabindex="0" aria-label="Back of ID card" aria-hidden="true">
                  <header class="id-card-header">
                    <img class="logo" src="${CONFIG.defaultLogo}" alt="College Logo" crossorigin="anonymous" loading="eager" />
                    <h3>GREAT LANDMARK COLLEGE</h3>
                  </header>
                  <div class="body-back">
                    <div class="meta">
                      <div class="title">Valid Until: ${utils.fmtDate(student.valid)}</div>
                      <div>Address: ${utils.sanitize(student.address) || '—'}</div>
                      <div>Phone: ${utils.sanitize(student.phone) || '—'}</div>
                      <div>Email: ${utils.sanitize(student.email) || '—'}</div>
                      <div>Website: www.greatlandmarkcollege.org</div>
                    </div>
                    <div class="qr" id="qr-${currentStudentIndex}"></div>
                    <div class="sign">
                      <p>Director’s Signature:</p>
                      ${student.signatureImg
                        ? `<img class="sig-img" src="${student.signatureImg}" alt="Director’s signature" crossorigin="anonymous">`
                        : `<div class="sig">${utils.sanitize(student.director || '')}</div>`
                      }
                      <div class="line"></div>
                    </div>
                  </div>
                  <footer class="footer">
                    IMPORTANT. If found, return to Great Landmark College. Alteration or misuse may lead to disciplinary action.
                  </footer>
                </section>
              </div>
            </div>
          `);
          qr.render(currentStudentIndex);

          // Generate print pages
          elements.printPages.innerHTML = '';
          const useImages = elements.tools.imageMode.checked;
          const dataUrls = [];
          if (useImages) {
            elements.loading.classList.add('active');
            const tempContainer = document.createElement('div');
            tempContainer.style.position = 'absolute';
            tempContainer.style.left = '-9999px';
            tempContainer.style.top = '0';
            tempContainer.style.width = '85.6mm';
            tempContainer.style.height = '54mm';
            tempContainer.style.overflow = 'visible';
            document.body.appendChild(tempContainer);
            for (let i = 0; i < students.length; i++) {
              const student = students[i];
              let dobHtml = '';
              if (student.showDob) {
                dobHtml = `<p class="kv"><strong>Date of Birth:</strong> <span>${utils.fmtDate(student.dob)}</span></p>`;
              }
              // Capture front
              tempContainer.innerHTML = `
                <section class="face front">
                  <header class="id-card-header">
                    <img class="logo" src="${CONFIG.defaultLogo}" alt="College Logo" crossorigin="anonymous" loading="eager" />
                    <h3>GREAT LANDMARK COLLEGE</h3>
                  </header>
                  <div class="body-front">
                    <div class="photo">
                      <img src="${student.photo}" alt="Student Photo" crossorigin="anonymous">
                    </div>
                    <div class="details">
                      <h4>STUDENT IDENTITY CARD</h4>
                      <p class="kv"><strong>Student Name:</strong> <span>${utils.sanitize(student.name) || '—'}</span></p>
                      <p class="kv"><strong>Admission No:</strong> <span>${student.adm?.match(elements.fields.adm.pattern) ? student.adm : '—'}</span></p>
                      <p class="kv"><strong>Class:</strong> <span>${utils.sanitize(student.klass) || '—'}</span></p>
                      ${dobHtml}
                    </div>
                  </div>
                  <footer class="footer">
                    IMPORTANT. This card is property of Great Landmark College. If found, return to the school. Misuse is prohibited.
                  </footer>
                </section>
              `;
              await document.fonts.ready;
              const frontUrl = await html2canvas(tempContainer.firstChild, {
                scale: CONFIG.captureScale,
                useCORS: true,
                logging: false,
                backgroundColor: null
              }).then(c => c.toDataURL('image/png'));

              // Capture back
              tempContainer.innerHTML = `
                <section class="face back">
                  <header class="id-card-header">
                    <img class="logo" src="${CONFIG.defaultLogo}" alt="College Logo" crossorigin="anonymous" loading="eager" />
                    <h3>GREAT LANDMARK COLLEGE</h3>
                  </header>
                  <div class="body-back">
                    <div class="meta">
                      <div class="title">Valid Until: ${utils.fmtDate(student.valid)}</div>
                      <div>Address: ${utils.sanitize(student.address) || '—'}</div>
                      <div>Phone: ${utils.sanitize(student.phone) || '—'}</div>
                      <div>Email: ${utils.sanitize(student.email) || '—'}</div>
                      <div>Website: www.greatlandmarkcollege.org</div>
                    </div>
                    <div class="qr"></div>
                    <div class="sign">
                      <p>Director’s Signature:</p>
                      ${student.signatureImg
                        ? `<img class="sig-img" src="${student.signatureImg}" alt="Director’s signature" crossorigin="anonymous">`
                        : `<div class="sig">${utils.sanitize(student.director || '')}</div>`
                      }
                      <div class="line"></div>
                    </div>
                  </div>
                  <footer class="footer">
                    IMPORTANT. If found, return to Great Landmark College. Alteration or misuse may lead to disciplinary action.
                  </footer>
                </section>
              `;
              const qrWrap = tempContainer.querySelector('.qr');
              qrWrap.innerHTML = '';
              new QRCode(qrWrap, {
                text: `Name: ${student.name || '-'}\nID: ${student.adm || '-'}\nValid Until: ${utils.fmtDate(student.valid)}\nWeb: www.greatlandmarkcollege.org` + (student.showDob ? `\nDate of Birth: ${utils.fmtDate(student.dob)}` : ''),
                width: CONFIG.qrSize,
                height: CONFIG.qrSize,
                colorDark: "#000",
                colorLight: "#fff",
                correctLevel: QRCode.CorrectLevel.H
              });
              await document.fonts.ready;
              const backUrl = await html2canvas(tempContainer.firstChild, {
                scale: CONFIG.captureScale,
                useCORS: true,
                logging: false,
                backgroundColor: null
              }).then(c => c.toDataURL('image/png'));
              dataUrls.push({ front: frontUrl, back: backUrl });
            }
            document.body.removeChild(tempContainer);
            elements.loading.classList.remove('active');
          }

          for (let i = 0; i < students.length; i += CONFIG.cardsPerPage) {
            const pageStudents = students.slice(i, i + CONFIG.cardsPerPage);
            let frontHtml = '<div class="front-grid">';
            let backHtml = '<div class="back-grid">';
            pageStudents.forEach((student, index) => {
              const globalIndex = i + index;
              let dobHtml = '';
              if (student.showDob) {
                dobHtml = `<p class="kv"><strong>Date of Birth:</strong> <span>${utils.fmtDate(student.dob)}</span></p>`;
              }
              if (useImages) {
                const {front, back} = dataUrls[globalIndex];
                frontHtml += `
                  <div class="id-card-wrapper">
                    <img src="${front}" style="width:100%; height:100%; display:block;" />
                  </div>
                `;
                backHtml += `
                  <div class="id-card-wrapper">
                    <img src="${back}" style="width:100%; height:100%; display:block;" />
                  </div>
                `;
              } else {
                const frontCardHtml = `
                  <div class="id-card-wrapper" aria-hidden="true">
                    <div class="id-card-container">
                      <section class="face front">
                        <header class="id-card-header">
                          <img class="logo" src="${CONFIG.defaultLogo}" alt="College Logo" crossorigin="anonymous" loading="eager" />
                          <h3>GREAT LANDMARK COLLEGE</h3>
                        </header>
                        <div class="body-front">
                          <div class="photo">
                            <img src="${student.photo}" alt="Student Photo" crossorigin="anonymous">
                          </div>
                          <div class="details">
                            <h4>STUDENT IDENTITY CARD</h4>
                            <p class="kv"><strong>Student Name:</strong> <span>${utils.sanitize(student.name) || '—'}</span></p>
                            <p class="kv"><strong>Admission No:</strong> <span>${student.adm?.match(elements.fields.adm.pattern) ? student.adm : '—'}</span></p>
                            <p class="kv"><strong>Class:</strong> <span>${utils.sanitize(student.klass) || '—'}</span></p>
                            ${dobHtml}
                          </div>
                        </div>
                        <footer class="footer">
                          IMPORTANT. This card is property of Great Landmark College. If found, return to the school. Misuse is prohibited.
                        </footer>
                      </section>
                    </div>
                  </div>
                `;
                const backCardHtml = `
                  <div class="id-card-wrapper" aria-hidden="true">
                    <div class="id-card-container">
                      <section class="face back">
                        <header class="id-card-header">
                          <img class="logo" src="${CONFIG.defaultLogo}" alt="College Logo" crossorigin="anonymous" loading="eager" />
                          <h3>GREAT LANDMARK COLLEGE</h3>
                        </header>
                        <div class="body-back">
                          <div class="meta">
                            <div class="title">Valid Until: ${utils.fmtDate(student.valid)}</div>
                            <div>Address: ${utils.sanitize(student.address) || '—'}</div>
                            <div>Phone: ${utils.sanitize(student.phone) || '—'}</div>
                            <div>Email: ${utils.sanitize(student.email) || '—'}</div>
                            <div>Website: www.greatlandmarkcollege.org</div>
                          </div>
                          <div class="qr" id="print-qr-${globalIndex}"></div>
                          <div class="sign">
                            <p>Director’s Signature:</p>
                            ${student.signatureImg
                              ? `<img class="sig-img" src="${student.signatureImg}" alt="Director’s signature" crossorigin="anonymous">`
                              : `<div class="sig">${utils.sanitize(student.director || '')}</div>`
                            }
                            <div class="line"></div>
                          </div>
                        </div>
                        <footer class="footer">
                          IMPORTANT. If found, return to Great Landmark College. Alteration or misuse may lead to disciplinary action.
                        </footer>
                      </section>
                    </div>
                  </div>
                `;
                frontHtml += frontCardHtml;
                backHtml += backCardHtml;
              }
            });
            frontHtml += '</div>';
            backHtml += '</div>';
            elements.printPages.insertAdjacentHTML('beforeend', `<div class="print-page">${frontHtml}${backHtml}</div>`);
            if (!useImages) {
              pageStudents.forEach((_, index) => qr.render(i + index));
            }
          }

          cardCaches[currentStudentIndex] = cardCaches[currentStudentIndex] || { frontCache: null, backCache: null };
          card.clearCache(currentStudentIndex);
          state.save();
          state.updateStudentSelect();
          state.updatePageCount();
          return isValid;
        }
      };

      // Card Download and Print
      const card = {
        clearCache(index) {
          if (index !== undefined && cardCaches[index]) {
            cardCaches[index].frontCache = cardCaches[index].backCache = null;
          }
        },
        async captureFace(index, selector) {
          elements.loading.classList.add('active');
          const cacheKey = selector.includes('.front') ? 'frontCache' : 'backCache';
          if (cardCaches[index]?.[cacheKey]) {
            elements.loading.classList.remove('active');
            return cardCaches[index][cacheKey];
          }
          const face = document.querySelector(`#card-${index} ${selector}`) || document.querySelector(`#print-card-${index} ${selector}`);
          if (!face) throw new Error('Card not found');
          const container = face.closest('.id-card-container');
          const wasFlipped = container.classList.contains('flipped');
          const originalStyle = face.style.boxShadow;
          face.style.boxShadow = 'none';
          if (selector.includes('.front') && wasFlipped) container.classList.remove('flipped');
          if (selector.includes('.back') && !wasFlipped) container.classList.add('flipped');
          await new Promise(r => setTimeout(r, 100));
          try {
            const canvas = await html2canvas(face, {
              scale: CONFIG.captureScale,
              useCORS: true,
              logging: false,
              backgroundColor: null
            });
            cardCaches[index] = cardCaches[index] || { frontCache: null, backCache: null };
            cardCaches[index][cacheKey] = canvas.toDataURL('image/png');
            return cardCaches[index][cacheKey];
          } catch (err) {
            console.error(`Failed to capture ${selector} for card ${index}:`, err);
            throw err;
          } finally {
            face.style.boxShadow = originalStyle;
            if (selector.includes('.front') && wasFlipped) container.classList.add('flipped');
            if (selector.includes('.back') && !wasFlipped) container.classList.remove('flipped');
            elements.loading.classList.remove('active');
          }
        },
        triggerDownload(dataUrl, filename) {
          const a = document.createElement('a');
          a.href = dataUrl;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          a.remove();
        }
      };

      // Print Helper
      const printHelper = {
        togglePrintBack(isBack) {
          const printPages = document.querySelectorAll('.print-page');
          printPages.forEach(page => {
            if (isBack) {
              page.classList.add('print-back');
            } else {
              page.classList.remove('print-back');
            }
          });
        }
      };

      // Event Handlers
      const events = {
        init() {
          elements.form.addEventListener('input', (e) => {
            clearTimeout(debounceTimer);
            if (e.target === elements.fields.photoUrl) {
              elements.fields.photoFile.value = '';
              photo.setPhoto().then(() => form.updatePreview());
            }
            if (e.target === elements.fields.signatureUrl) {
              elements.fields.signatureFile.value = '';
              signature.setSignature().then(() => form.updatePreview());
            }
            debounceTimer = setTimeout(() => form.updatePreview(), CONFIG.debounceDelay);
          });

          elements.fields.photoFile.addEventListener('change', async () => {
            await photo.setPhoto();
            form.updatePreview();
          });

          elements.fields.signatureFile.addEventListener('change', async () => {
            await signature.setSignature();
            form.updatePreview();
          });

          elements.form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!form.updatePreview()) return;
            await photo.setPhoto();
          });

          elements.tools.flipBtn.addEventListener('click', () => {
            const container = document.querySelector(`#card-${currentStudentIndex}`);
            if (container) {
              container.classList.toggle('flipped');
              const isFlipped = container.classList.contains('flipped');
              container.querySelector('.front').setAttribute('aria-hidden', isFlipped);
              container.querySelector('.back').setAttribute('aria-hidden', !isFlipped);
            }
          });

          elements.idStage.addEventListener('keydown', (e) => {
            if (e.key === ' ' || e.key === 'Enter') {
              e.preventDefault();
              elements.tools.flipBtn.click();
            }
          });

          elements.tools.printFrontsBtn.addEventListener('click', () => {
            printHelper.togglePrintBack(false);
            window.print();
          });

          elements.tools.printBacksBtn.addEventListener('click', () => {
            printHelper.togglePrintBack(true);
            window.print();
          });

          elements.tools.imageMode.addEventListener('change', () => {
            form.updatePreview();
          });

          document.getElementById('paperSize').addEventListener('change', (e)=>{
            if(e.target.value==="Letter"){
              document.documentElement.style.setProperty('--page-w','215.9mm');
              document.documentElement.style.setProperty('--page-h','279.4mm');
            } else {
              document.documentElement.style.setProperty('--page-w','210mm');
              document.documentElement.style.setProperty('--page-h','297mm');
            }
            form.updatePreview();
          });

          elements.tools.resetBtn.addEventListener('click', () => {
            localStorage.removeItem('glc_id_state');
            window.location.reload();
          });

          elements.tools.addStudentBtn.addEventListener('click', () => {
            students.push({
              name: '', adm: '', klass: '', dob: '', validForYears: 1, valid: computeValidDate(1), director: '',
              showDob: true,
              signatureImg: null,
              photo: CONFIG.defaultPhoto, phone: '', email: '', address: ''
            });
            currentStudentIndex = students.length - 1;
            state.updateForm();
            form.updatePreview();
          });

          elements.tools.removeStudentBtn.addEventListener('click', () => {
            if (students.length <= 1) return;
            students.splice(currentStudentIndex, 1);
            currentStudentIndex = Math.min(currentStudentIndex, students.length - 1);
            state.updateForm();
            form.updatePreview();
          });

          elements.fields.studentSelect.addEventListener('change', (e) => {
            currentStudentIndex = parseInt(e.target.value, 10);
            state.updateForm();
            form.updatePreview();
          });

          if (!window.html2canvas) {
            alert('html2canvas not loaded.');
          }
        }
      };

      // Boot
      window.addEventListener('load', () => {
        state.load();
        photo.preloadLogos().then(() => {
          form.updatePreview();
        });
        events.init();
      });
    })();
  </script>
</body>
</html>