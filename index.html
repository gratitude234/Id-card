<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ID Card Generator ‚Äî Great Landmark College</title>

  <!-- html2canvas (only used for optional "Render as images" mode) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --blue:#0d2f6f; --yellow:#f9a825; --red:#e54c4c; --bg:#f8fafc; --ink:#1e293b;
      --radius:16px; --pad:20px; --shadow:0 8px 32px rgba(0,0,0,.08); --shadow-lg:0 20px 40px rgba(0,0,0,.12);
      --border:1px solid #e2e8f0;

      /* paper */
      --page-w:210mm; --page-h:297mm;

      /* true card size */
      --card-w:85.6mm; --card-h:54mm;

      /* watermark tuning */
      --wm-opacity: .09;
      --wm-ring: rgba(13,47,111,.08);
      --wm-script: rgba(13,47,111,.12);

      /* spacing scales */
      --space-xs: 0.5rem; --space-sm: 1rem; --space-md: 1.5rem; --space-lg: 2rem; --space-xl: 3rem;
    }

    *, *::before, *::after { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, var(--bg) 0%, #e2e8f0 100%);
      color: var(--ink);
      padding: clamp(1rem, 4vw, var(--space-md));
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      line-height: 1.6;
    }

    .container {
      background: #fff;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      max-width: 1200px;
      width: 100%;
      padding: var(--space-lg);
      margin-bottom: var(--space-md);
    }

    h1 {
      margin: 0 0 var(--space-md);
      text-align: center;
      color: var(--blue);
      font-size: clamp(1.75rem, 4vw, 2.5rem);
      font-weight: 700;
      letter-spacing: -0.025em;
    }

    h2 {
      margin: var(--space-xl) 0 var(--space-md);
      color: var(--blue);
      border-bottom: 2px solid #e2e8f0;
      padding-bottom: var(--space-sm);
      font-size: clamp(1.25rem, 3vw, 1.5rem);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }

    h2::before {
      content: "üéì";
      font-size: 1.2em;
    }

    /* Main layout grid */
    .main-layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-xl);
      margin-top: var(--space-lg);
    }

    /* Form and controls */
    .form-section {
      display: flex;
      flex-direction: column;
      gap: var(--space-md);
    }

    .student-controls {
      display: flex;
      gap: var(--space-sm);
      align-items: center;
      flex-wrap: wrap;
      padding: var(--space-sm);
      background: #f8fafc;
      border-radius: var(--radius);
      border: var(--border);
    }

    .student-controls select {
      flex: 1;
      min-width: 200px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: var(--space-md);
    }

    .col-full { grid-column: 1 / -1; }

    .row {
      display: flex;
      gap: var(--space-sm);
      flex-wrap: wrap;
      align-items: center;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: var(--space-xs);
      position: relative;
    }

    .form-group label {
      font-weight: 600;
      color: #475569;
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .form-group input[type="text"],
    .form-group input[type="date"],
    .form-group input[type="url"],
    .form-group input[type="email"],
    .form-group select {
      padding: var(--space-sm);
      border: var(--border);
      border-radius: var(--radius);
      font-size: 1rem;
      background: #fff;
      transition: all 0.2s ease;
      min-height: 44px; /* Touch-friendly */
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--blue);
      box-shadow: 0 0 0 3px rgba(13, 47, 111, 0.1);
      transform: translateY(-1px);
    }

    .help-text {
      font-size: 0.75rem;
      color: #64748b;
      margin-top: 0.25rem;
    }

    .error-text {
      display: none;
      color: var(--red);
      font-size: 0.75rem;
      margin-top: 0.25rem;
    }

    .form-actions {
      display: flex;
      gap: var(--space-sm);
      flex-wrap: wrap;
      justify-content: flex-start;
      margin-top: var(--space-md);
    }

    .btn {
      background: var(--blue);
      color: #fff;
      border: none;
      border-radius: var(--radius);
      padding: var(--space-sm) var(--space-md);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      min-height: 44px;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      text-decoration: none;
    }

    .btn:hover {
      background: #1e3a8a;
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn.secondary {
      background: #f1f5f9;
      color: var(--blue);
      border: var(--border);
    }

    .btn.secondary:hover {
      background: #e2e8f0;
      color: var(--blue);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .tools {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-sm);
      justify-content: center;
      align-items: center;
      margin: var(--space-md) 0;
      padding: var(--space-sm);
      background: #f8fafc;
      border-radius: var(--radius);
      border: var(--border);
    }

    .tools label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      color: #475569;
      cursor: pointer;
      padding: var(--space-xs) var(--space-sm);
      border-radius: var(--radius);
      transition: background 0.2s ease;
      white-space: nowrap;
    }

    .tools label:hover {
      background: #e2e8f0;
    }

    .tools input[type="checkbox"] {
      margin: 0;
    }

    /* Preview section */
    .preview-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--space-md);
      background: #fff;
      border-radius: var(--radius);
      padding: var(--space-lg);
      box-shadow: var(--shadow);
    }

    .id-stage {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: var(--space-sm);
    }

    .id-card-wrapper {
      width: clamp(280px, 40vw, 400px);
      aspect-ratio: 85.6 / 54;
      position: relative;
      margin: 0 auto;
      perspective: 1000px;
    }

    .id-card-container {
      position: absolute;
      inset: 0;
      transform-style: preserve-3d;
      transition: transform 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    .id-card-container.flipped {
      transform: rotateY(180deg);
    }

    .face {
      position: absolute;
      inset: 0;
      background: #fff;
      border-radius: var(--radius);
      box-shadow: var(--shadow-lg);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      backface-visibility: hidden;
      transform-style: preserve-3d;
    }

    .back {
      transform: rotateY(180deg);
    }

    .id-card-header {
      flex: 0 0 40px;
      height: 40px;
      background: var(--blue);
      color: #fff;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 14px;
      border-bottom: 3px solid var(--yellow);
    }

    .id-card-header img.logo {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      object-fit: cover;
      background: #fff;
      flex-shrink: 0;
    }

    .id-card-header h3 {
      margin: 0;
      font-weight: 800;
      font-size: 15px;
      letter-spacing: 0.3px;
    }

    .body-front {
      flex: 1 1 auto;
      min-height: 0;
      padding: 12px;
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }

    .body-back {
      flex: 1 1 auto;
      min-height: 0;
      padding: 6mm;
      display: block;
      text-align: center;
    }

    .meta {
      font-size: 3.2mm;
      line-height: 1.3;
    }

    .photo {
      width: 74px;
      height: 74px;
      border: 2px solid var(--yellow);
      border-radius: 10px;
      overflow: hidden;
      flex-shrink: 0;
      box-shadow: 0 4px 12px rgba(249, 168, 37, 0.3);
    }

    .photo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center;
      transition: transform 0.3s ease;
    }

    .photo:hover img {
      transform: scale(1.05);
    }

    .details {
      flex: 1;
      min-width: 0;
    }

    .details h4 {
      margin: 0 0 6px;
      font-size: 13px;
      color: var(--blue);
      border-bottom: 1px solid #e2e8f0;
      padding-bottom: 4px;
      font-weight: 800;
    }

    .kv {
      display: flex;
      gap: 8px;
      margin: 3px 0;
      font-size: 11px;
      line-height: 1.35;
    }

    .kv strong {
      color: var(--blue);
      min-width: 92px;
      font-weight: 600;
    }

    .kv span {
      flex: 1;
      min-width: 0;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .kv.name span {
      font-weight: 700;
      color: var(--ink);
    }

    .kv.name.long span {
      font-size: 10px;
    }

    .footer {
      flex: 0 0 auto;
      margin-top: auto;
      background: var(--red);
      color: #fff;
      text-align: center;
      font-weight: 600;
      font-size: 9px;
      padding: 6px 10px;
      letter-spacing: 0.5px;
    }

    /* WATERMARK */
    .wm {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      z-index: 0;
    }

    .wm .crest {
      max-width: 220px;
      width: 65%;
      filter: grayscale(100%);
      opacity: var(--wm-opacity);
    }

    .wm .ring {
      position: absolute;
      width: 78%;
      height: 78%;
      border-radius: 50%;
      border: 0.6mm solid var(--wm-ring);
      opacity: 0.6;
    }

    .wm .script {
      position: absolute;
      left: -10%;
      right: -10%;
      top: 52%;
      transform: rotate(-18deg) translateY(-50%);
      text-align: center;
      font-family: 'Great Vibes', cursive;
      font-size: 24px;
      letter-spacing: 0.05em;
      color: var(--wm-script);
      opacity: 0.75;
      text-shadow: 0 0 1px rgba(0,0,0,.03);
    }

    /* PRINTING LAYOUT */
    #printPages { display: none; }
    .print-page {
      display: block;
      width: var(--page-w);
      height: var(--page-h);
      position: relative;
      margin: 0 auto;
      page-break-after: always;
    }

    .grid-surface {
      position: absolute;
      inset: 0;
      display: grid;
      justify-content: center;
      align-content: start;
    }

    .id-card-wrapper.print {
      width: var(--card-w);
      height: var(--card-h);
    }

    .face.print {
      width: var(--card-w);
      height: var(--card-h);
      box-shadow: none;
      border-radius: 2mm;
      overflow: hidden;
    }

    .loading {
      display: none;
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,.85);
      color: #fff;
      padding: var(--space-sm) var(--space-md);
      border-radius: var(--radius);
      z-index: 1000;
      font-weight: 500;
    }

    .loading.active {
      display: flex;
      gap: var(--space-sm);
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .loading::before {
      content: "‚è≥";
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .notes {
      text-align: center;
      font-size: 0.875rem;
      color: #64748b;
      margin-top: var(--space-md);
      padding: var(--space-sm);
      background: #f8fafc;
      border-radius: var(--radius);
      border-left: 4px solid var(--yellow);
    }

    /* PRINT RULES */
    @media print {
      @page { size: auto; margin: 0; }
      html, body, * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; forced-color-adjust: none !important; }
      body { background: #fff; padding: 0; margin: 0; }

      .container, .id-stage, .tools, .form-section, .notes, .loading, h1, h2, .main-layout, .preview-section { display: none !important; }
      #printPages { display: block !important; }

      .id-card-header { background-color: var(--blue) !important; color: #fff !important; border-bottom-color: var(--yellow) !important; }
      .footer { background-color: var(--red) !important; color: #fff !important; }
    }

    /* Mobile and responsive */
    @media (max-width: 1024px) {
      .main-layout {
        grid-template-columns: 1fr;
        gap: var(--space-lg);
      }

      .preview-section {
        order: -1; /* Preview above form on small screens */
      }

      .tools {
        justify-content: flex-start;
      }
    }

    @media (max-width: 768px) {
      body { padding: clamp(0.75rem, 3vw, 1rem); }
      .container { padding: var(--space-md); }
      .grid { grid-template-columns: 1fr; gap: var(--space-sm); }
      .btn, .tools label { width: 100%; justify-content: center; }
      .student-controls { flex-direction: column; align-items: stretch; }
      .student-controls select { min-width: auto; }
      .form-actions { flex-direction: column; }
      .id-card-wrapper { max-width: 90vw; }
      .id-card-header h3 { font-size: 14px; }
      .kv { font-size: 10px; }
      .footer { font-size: 8px; }
      .tools { flex-direction: column; align-items: stretch; }
    }

    @media (max-width: 480px) {
      h1 { font-size: 1.5rem; }
      h2 { font-size: 1.125rem; }
      .photo { width: 60px; height: 60px; }
      .details h4 { font-size: 12px; }
    }

    /* Dark mode support (optional enhancement) */
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0f172a;
        --ink: #f1f5f9;
      }
      body { background: linear-gradient(135deg, var(--bg) 0%, #1e293b 100%); }
      .container { background: #1e293b; }
      .form-group input, .form-group select { background: #334155; border-color: #475569; color: #f1f5f9; }
      .student-controls, .tools, .notes { background: #334155; border-color: #475569; color: #f1f5f9; }
      .kv strong { color: #60a5fa; }
    }
  </style>
</head>
<body>

  <!-- PRINT HOST lives OUTSIDE .container so it‚Äôs not hidden in @media print -->
  <div id="printPages" role="presentation"></div>

  <div class="container" aria-live="polite">
    <h1>Great Landmark College ID Card Generator</h1>

    <div class="main-layout">
      <section class="form-section">
        <h2>Enter Student Details</h2>
        <div class="student-controls">
          <div class="form-group" style="flex: 1;">
            <label for="studentSelect">Select Student</label>
            <select id="studentSelect"></select>
          </div>
          <button class="btn secondary" id="addStudentBtn" type="button">Add Student</button>
          <button class="btn secondary" id="removeStudentBtn" type="button" disabled>Remove</button>
        </div>

        <form id="form" novalidate>
          <div class="grid">
            <div>
              <div class="form-group">
                <label for="studentName">üë§ Student Name</label>
                <input id="studentName" type="text" required value="ADEKUNLE SAMUEL"/>
                <div class="error-text" id="errName">Please enter a name.</div>
              </div>
            </div>

            <div>
              <div class="form-group">
                <label for="dob">üìÖ Date of Birth (DOB)</label>
                <input id="dob" type="date" required/>
                <div class="error-text" id="errDob">Please enter a valid date.</div>
              </div>
            </div>

            <div>
              <div class="form-group">
                <label for="admissionNo">üÜî Admission No</label>
                <input id="admissionNo" type="text" required placeholder="GLC/2025/001" pattern="^[A-Za-z]{3}\/\d{4}\/\d{3}$" value="GLC/2025/001"/>
                <div class="error-text" id="errAdm">Use format GLC/2025/001.</div>
              </div>
            </div>

            <div>
              <div class="form-group">
                <label for="klass">üè´ Class</label>
                <input id="klass" type="text" required value="SS1 A"/>
                <div class="error-text" id="errClass">Please enter a class.</div>
              </div>
            </div>

            <div>
              <div class="form-group">
                <label for="gender">‚ößÔ∏è Gender</label>
                <select id="gender" required>
                  <option>Male</option><option>Female</option><option>Other</option>
                </select>
                <div class="error-text" id="errGender">Please select a gender.</div>
              </div>
            </div>

            <div>
              <div class="form-group">
                <label for="validForYears">üìä Valid For</label>
                <select id="validForYears">
                  <option value="1" selected>1 year</option>
                  <option value="2">2 years</option>
                  <option value="3">3 years</option>
                  <option value="4">4 years</option>
                  <option value="5">5 years</option>
                </select>
              </div>
            </div>

            <div class="col-full">
              <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; cursor: pointer;">
                <input type="checkbox" id="showGender" checked> üë§ Show Gender on card
              </label>
            </div>

            <div class="col-full">
              <div class="form-group">
                <label for="photoUrl">üì∏ Student Photo URL</label>
                <input id="photoUrl" type="url" placeholder="https://example.com/photo.jpg" value="https://via.placeholder.com/300x300?text=Student"/>
                <div class="row">
                  <input id="photoFile" type="file" accept="image/*,image/heic,image/heif" style="flex: 1;"/>
                  <span class="help-text">Upload overrides URL. Auto-cropped & compressed.</span>
                </div>
                <div class="error-text" id="errPhoto"></div>
              </div>
            </div>

            <div>
              <div class="form-group">
                <label for="phone">üìû Phone</label>
                <input id="phone" type="text" value="+234 801 123 4567"/>
              </div>
            </div>

            <div>
              <div class="form-group">
                <label for="email">‚úâÔ∏è Email</label>
                <input id="email" type="email" value="info@greatlandmarkcollege.org"/>
              </div>
            </div>

            <div class="col-full">
              <div class="form-group">
                <label for="address">üè† Address</label>
                <input id="address" type="text" value="45, Oke Alaro Rd, Abusoro, Akure"/>
              </div>
            </div>

            <div class="col-full form-actions">
              <button class="btn" type="submit">üîÑ Update Preview</button>
              <button class="btn secondary" type="button" id="resetBtn">‚Ü©Ô∏è Reset</button>
            </div>
          </div>
        </form>
      </section>

      <section class="preview-section">
        <h2>Preview</h2>
        <div class="tools">
          <button class="btn secondary" id="flipBtn" type="button">üîÑ Flip Card</button>
          <button class="btn secondary" id="printFrontsBtn" type="button">üñ®Ô∏è Print Fronts</button>
          <button class="btn secondary" id="printBacksBtn" type="button">üñ®Ô∏è Print Backs</button>

          <label class="btn secondary" style="display:inline-flex;gap:.5rem;align-items:center; min-width: auto;">
            üìÑ Paper
            <select id="paperSize"><option value="A4" selected>A4</option><option value="Letter">Letter</option></select>
          </label>
          <label class="btn secondary" style="display:inline-flex;gap:.5rem;align-items:center; min-width: auto;">
            üîó Duplex (Edge)
            <select id="duplexMode"><option value="long" selected>Long-edge</option><option value="short">Short-edge</option></select>
          </label>
          <label class="btn secondary" style="display:inline-flex;gap:.5rem;align-items:center; min-width: auto;">
            üéØ Cards / Sheet
            <select id="cardsPerPage"><option value="4" selected>4 (2√ó2)</option><option value="8">8 (2√ó4)</option></select>
          </label>
          <label style="display:flex;align-items:center;font-size:14px;color:#444;gap:.4rem; order: 3; width: 100%; justify-content: center;">
            <input type="checkbox" id="imageMode"> üñºÔ∏è Render as images
          </label>
          <label style="display:flex;align-items:center;font-size:14px;color:#444;gap:.4rem; order: 4; width: 100%; justify-content: center;">
            <input type="checkbox" id="mirrorBack"> üîÑ Reverse left-right (back)
          </label>
        </div>

        <div class="id-stage" id="idStage"></div>
        <p class="notes" id="pageNote">üí° Tip: Print fronts first, then backs. Use Long-edge for duplex printers. Enable ‚ÄúReverse left-right‚Äù if backs are mirrored.</p>
      </section>
    </div>

    <div class="loading">Processing‚Ä¶</div>
  </div>

  <script>
  (function(){
    const CONFIG={
      defaultPhoto:'https://via.placeholder.com/300x300?text=Student',
      defaultLogo:'/glc-logo.jpg', // <-- your actual logo file (same-origin)
      captureScale:2
    };

    const els={
      form:document.getElementById('form'),
      idStage:document.getElementById('idStage'),
      printPages:document.getElementById('printPages'),
      loading:document.querySelector('.loading'),
      note:document.getElementById('pageNote'),
      tools:{
        flipBtn:document.getElementById('flipBtn'),
        printFrontsBtn:document.getElementById('printFrontsBtn'),
        printBacksBtn:document.getElementById('printBacksBtn'),
        paperSize:document.getElementById('paperSize'),
        duplexMode:document.getElementById('duplexMode'),
        cardsPerPage:document.getElementById('cardsPerPage'),
        imageMode:document.getElementById('imageMode'),
        mirrorBack:document.getElementById('mirrorBack'),
        addStudentBtn:document.getElementById('addStudentBtn'),
        removeStudentBtn:document.getElementById('removeStudentBtn')
      },
      fields:{
        name:document.getElementById('studentName'),
        dob:document.getElementById('dob'),
        adm:document.getElementById('admissionNo'),
        klass:document.getElementById('klass'),
        gender:document.getElementById('gender'),
        validForYears:document.getElementById('validForYears'),
        showGender:document.getElementById('showGender'),
        photoUrl:document.getElementById('photoUrl'),
        photoFile:document.getElementById('photoFile'),
        phone:document.getElementById('phone'),
        email:document.getElementById('email'),
        address:document.getElementById('address'),
        studentSelect:document.getElementById('studentSelect')
      },
      errors:{
        name:document.getElementById('errName'),
        dob:document.getElementById('errDob'),
        adm:document.getElementById('errAdm'),
        klass:document.getElementById('errClass'),
        gender:document.getElementById('errGender'),
        photo:document.getElementById('errPhoto')
      }
    };

    let students=[{
      name:'ADEKUNLE SAMUEL', dob:'', adm:'GLC/2025/001', klass:'SS1 A', gender:'Male', showGender:true,
      validForYears:1, validUntil:futureDate(1), photo:CONFIG.defaultPhoto,
      phone:'+234 801 123 4567', email:'info@greatlandmarkcollege.org', address:'45, Oke Alaro Rd, Abusoro, Akure'
    }];
    let idx=0;

    /* helpers */
    function futureDate(years){const d=new Date();d.setFullYear(d.getFullYear()+years);return d.toISOString().split('T')[0]}
    function sanitize(s){return String(s||'').replace(/[<>&"']/g,c=>'&#'+c.charCodeAt(0)+';')}
    function showErr(el,on,msg){if(!el)return; el.style.display=on?'block':'none'; if(msg)el.textContent=msg;}
    function normalizeClass(s){return s.replace(/\b([A-Za-z]+)\s+(\d)/g,'$1$2').replace(/\s+/g,' ').trim()}
    async function preload(src){return new Promise((res,rej)=>{const i=new Image();i.onload=()=>res();i.onerror=()=>rej();i.src=src;});}
    async function fileToDataUrl(f){return new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result);r.onerror=rej;r.readAsDataURL(f);});}
    async function resizeImage(file,max=360){
      const data=await fileToDataUrl(file); const img=new Image(); img.src=data;
      return new Promise(resolve=>{
        img.onload=()=>{const s=Math.min(max/img.width,max/img.height,1);const c=document.createElement('canvas');c.width=img.width*s;c.height=img.height*s;c.getContext('2d').drawImage(img,0,0,c.width,c.height);resolve(c.toDataURL('image/jpeg',0.82));};
        img.onerror=()=>resolve(CONFIG.defaultPhoto);
      });
    }

    function updateSelect(){
      els.fields.studentSelect.innerHTML = students.map((s,i)=>`<option value="${i}">Student ${i+1}${s.name?`: ${s.name}`:''}</option>`).join('');
      els.fields.studentSelect.value = idx;
      const per = Number(els.tools.cardsPerPage.value); const pages=Math.ceil(students.length/per)||1;
      els.note.textContent = `${students.length} card${students.length!==1?'s':''} ‚Ä¢ ${per} per sheet ‚Ä¢ about ${pages} page${pages!==1?'s':''}.`;
      els.tools.removeStudentBtn.disabled = students.length<=1;
    }

    function loadForm(){
      const s=students[idx];
      els.fields.name.value=s.name||''; els.fields.dob.value=s.dob||''; els.fields.adm.value=s.adm||'';
      els.fields.klass.value=s.klass||''; els.fields.gender.value=s.gender||'Male';
      els.fields.validForYears.value=s.validForYears||1; els.fields.showGender.checked=s.showGender!==false;
      els.fields.photoUrl.value=(s.photo&&s.photo.startsWith('http'))?s.photo:''; els.fields.photoFile.value='';
      els.fields.phone.value=s.phone||''; els.fields.email.value=s.email||''; els.fields.address.value=s.address||'';
    }

    function readFormIntoState(){
      const s=students[idx];
      s.name=els.fields.name.value.trim();
      s.dob=els.fields.dob.value;
      s.adm=els.fields.adm.value.trim();
      s.klass=normalizeClass(els.fields.klass.value.trim());
      s.gender=els.fields.gender.value;
      s.validForYears=parseInt(els.fields.validForYears.value||'1',10);
      s.validUntil=futureDate(s.validForYears);
      s.showGender=els.fields.showGender.checked;
      s.phone=els.fields.phone.value.trim();
      s.email=els.fields.email.value.trim();
      s.address=els.fields.address.value.trim();
    }

    function validField(input,errEl,pattern){const v=input.value.trim();const ok=pattern?new RegExp(pattern).test(v):!!v;showErr(errEl,!ok);return ok;}

    async function updatePreview(){
      readFormIntoState();
      const ok=[
        validField(els.fields.name,els.errors.name),
        validField(els.fields.dob,els.errors.dob),
        validField(els.fields.adm,els.errors.adm,els.fields.adm.pattern),
        validField(els.fields.klass,els.errors.klass),
        validField(els.fields.gender,els.errors.gender)
      ].every(Boolean);

      const s=students[idx];
      const longName=(s.name||'').length>24;

      els.idStage.innerHTML = `
        <div class="id-card-wrapper">
          <div class="id-card-container" id="card-${idx}">
            <section class="face front" aria-hidden="false">
              <div class="wm">
                <img class="crest" src="${CONFIG.defaultLogo}" alt="">
                <div class="ring" aria-hidden="true"></div>
                <div class="script">Great Landmark College</div>
              </div>
              <header class="id-card-header">
                <img class="logo" src="${CONFIG.defaultLogo}" alt="College Logo" loading="eager"/>
                <h3>GREAT LANDMARK COLLEGE</h3>
              </header>
              <div class="body-front">
                <div class="photo"><img src="${s.photo||CONFIG.defaultPhoto}" alt="Student Photo" loading="lazy"></div>
                <div class="details">
                  <h4>STUDENT IDENTITY CARD</h4>
                  <p class="kv name ${longName?'long':''}"><strong>Student Name:</strong> <span>${sanitize(s.name)||'‚Äî'}</span></p>
                  <p class="kv"><strong>Admission No:</strong> <span>${(s.adm||'').match(els.fields.adm.pattern)?s.adm:'‚Äî'}</span></p>
                  <p class="kv"><strong>DOB:</strong> <span>${s.dob||'‚Äî'}</span></p>
                  <p class="kv"><strong>Class:</strong> <span>${sanitize(s.klass)||'‚Äî'}</span></p>
                  ${s.showGender?`<p class="kv"><strong>Gender:</strong> <span>${sanitize(s.gender)}</span></p>`:''}
                </div>
              </div>
              <footer class="footer">IMPORTANT. This card is property of Great Landmark College. If found, return to the school. Misuse is prohibited.</footer>
            </section>

            <section class="face back" aria-hidden="true">
              <div class="wm">
                <img class="crest" src="${CONFIG.defaultLogo}" alt="">
                <div class="ring" aria-hidden="true"></div>
                <div class="script">Great Landmark College</div>
              </div>
              <header class="id-card-header">
                <img class="logo" src="${CONFIG.defaultLogo}" alt="College Logo" loading="eager"/>
                <h3>GREAT LANDMARK COLLEGE</h3>
              </header>
              <div class="body-back">
                <div class="meta">
                  <div class="title" style="font-weight:800;margin-bottom:1mm">Valid Until: ${s.validUntil}</div>
                  <div>Address: ${sanitize(s.address)||'‚Äî'}</div>
                  <div>Phone: ${sanitize(s.phone)||'‚Äî'}</div>
                  <div>Email: ${sanitize(s.email)||'‚Äî'}</div>
                  <div>Website: www.greatlandmarkcollege.org</div>
                </div>
              </div>
              <footer class="footer">IMPORTANT. If found, return to Great Landmark College. Alteration or misuse may lead to disciplinary action.</footer>
            </section>
          </div>
        </div>`;

      await buildPrintPages('front'); // keep preview and print pages in sync
      return ok;
    }

    /* ---- PRINT PAGE BUILDERS ---- */
    function wmBlock(){
      return `
        <div class="wm">
          <img class="crest" src="${CONFIG.defaultLogo}" alt="">
          <div class="ring" aria-hidden="true"></div>
          <div class="script">Great Landmark College</div>
        </div>`;
    }

    function htmlFrontCard(s){
      const longName=(s.name||'').length>24;
      const wrap=document.createElement('div'); wrap.className='id-card-wrapper print';
      wrap.innerHTML=`<div class="id-card-container">
        <section class="face print">
          ${wmBlock()}
          <header class="id-card-header"><img class="logo" src="${CONFIG.defaultLogo}" alt="College Logo"/><h3>GREAT LANDMARK COLLEGE</h3></header>
          <div class="body-front">
            <div class="photo"><img src="${s.photo||CONFIG.defaultPhoto}" alt="Student Photo"></div>
            <div class="details">
              <h4>STUDENT IDENTITY CARD</h4>
              <p class="kv name ${longName?'long':''}"><strong>Student Name:</strong> <span>${sanitize(s.name)||'‚Äî'}</span></p>
              <p class="kv"><strong>Admission No:</strong> <span>${(s.adm||'').match(els.fields.adm.pattern)?s.adm:'‚Äî'}</span></p>
              <p class="kv"><strong>DOB:</strong> <span>${s.dob||'‚Äî'}</span></p>
              <p class="kv"><strong>Class:</strong> <span>${sanitize(s.klass)||'‚Äî'}</span></p>
              ${s.showGender?`<p class="kv"><strong>Gender:</strong> <span>${sanitize(s.gender)}</span></p>`:''}
            </div>
          </div>
          <footer class="footer">IMPORTANT. This card is property of Great Landmark College. If found, return to the school. Misuse is prohibited.</footer>
        </section>
      </div>`;
      return wrap;
    }

    function htmlBackCard(s){
      const wrap=document.createElement('div'); wrap.className='id-card-wrapper print';
      wrap.innerHTML=`<div class="id-card-container">
        <section class="face print">
          ${wmBlock()}
          <header class="id-card-header"><img class="logo" src="${CONFIG.defaultLogo}" alt="College Logo"/><h3>GREAT LANDMARK COLLEGE</h3></header>
          <div class="body-back">
            <div class="meta">
              <div class="title" style="font-weight:800;margin-bottom:1mm">Valid Until: ${s.validUntil}</div>
              <div>Address: ${sanitize(s.address)||'‚Äî'}</div>
              <div>Phone: ${sanitize(s.phone)||'‚Äî'}</div>
              <div>Email: ${sanitize(s.email)||'‚Äî'}</div>
              <div>Website: www.greatlandmarkcollege.org</div>
            </div>
          </div>
          <footer class="footer">IMPORTANT. If found, return to Great Landmark College. Alteration or misuse may lead to disciplinary action.</footer>
        </section>
      </div>`;
      return wrap;
    }

    async function renderAllToImages(){
      els.loading.classList.add('active');
      const tmp=document.createElement('div');
      tmp.style.position='absolute'; tmp.style.left='-9999px';
      tmp.style.width='var(--card-w)'; tmp.style.height='var(--card-h)';
      document.body.appendChild(tmp);

      const out=[];
      for(let i=0;i<students.length;i++){
        const s=students[i];
        try{
          tmp.innerHTML=''; tmp.appendChild(htmlFrontCard(s));
          await document.fonts.ready;
          const frontCanvas = await html2canvas(tmp.querySelector('.face'),{scale:CONFIG.captureScale,useCORS:true,backgroundColor:'#ffffff'});
          const front = frontCanvas.toDataURL('image/png');

          tmp.innerHTML=''; tmp.appendChild(htmlBackCard(s));
          await document.fonts.ready;
          const backCanvas = await html2canvas(tmp.querySelector('.face'),{scale:CONFIG.captureScale,useCORS:true,backgroundColor:'#ffffff'});
          const back = backCanvas.toDataURL('image/png');

          out.push({front,back});
        }catch(e){
          els.tools.imageMode.checked=false;
          document.body.removeChild(tmp);
          els.loading.classList.remove('active');
          return null;
        }
      }
      document.body.removeChild(tmp);
      els.loading.classList.remove('active');
      return out;
    }

    function backTransform(){
      const mode = els.tools.duplexMode.value; // 'long' or 'short'
      const mirror = els.tools.mirrorBack.checked;
      if (mirror) return 'scaleX(-1)';           // real mirror fix (rare)
      return (mode==='long') ? 'rotate(180deg)' : 'none'; // typical duplex alignment
    }

    async function buildPrintPages(side='front'){
      const per=Number(els.tools.cardsPerPage.value);
      const cols=2, rows=per/cols;
      const gap= per===8 ? '6mm' : '10mm';
      const useImages=els.tools.imageMode.checked;

      els.printPages.innerHTML='';
      let images=null;
      if(useImages){
        images=await renderAllToImages();
        if(!images){ return buildPrintPages(side); } // fallback to HTML mode if canvas tainted
      }

      for(let i=0;i<students.length;i+=per){
        const pageStudents=students.slice(i,i+per);
        const page=document.createElement('div'); page.className='print-page';

        const sheet=document.createElement('div'); sheet.className='grid-surface';
        sheet.style.gridTemplateColumns=`repeat(${cols}, var(--card-w))`;
        sheet.style.gridTemplateRows=`repeat(${rows}, var(--card-h))`;
        sheet.style.gap=gap;

        if(side==='back'){ sheet.style.transform = backTransform(); }

        pageStudents.forEach((s,ix)=>{
          const gi=i+ix;
          if(useImages){
            const cell=document.createElement('div'); cell.className='id-card-wrapper print';
            const src = (side==='front') ? images[gi].front : images[gi].back;
            cell.innerHTML=`<img src="${src}" style="width:100%;height:100%;display:block" alt="Card ${side}">`;
            sheet.appendChild(cell);
          }else{
            sheet.appendChild(side==='front' ? htmlFrontCard(s) : htmlBackCard(s));
          }
        });

        page.appendChild(sheet);
        els.printPages.appendChild(page);
      }
    }

    /* print helpers */
    async function doPrint(side){
      await buildPrintPages(side);  // only the requested side exists => zero confusion
      // Give layout a tick before opening the dialog
      requestAnimationFrame(()=>{ setTimeout(()=>window.print(), 50); });
    }

    /* EVENTS */
    function bind(){
      els.form.addEventListener('input', async (e)=>{
        if(e.target===els.fields.photoUrl && els.fields.photoUrl.value){
          try{ await preload(els.fields.photoUrl.value); students[idx].photo=els.fields.photoUrl.value; }
          catch{ showErr(els.errors.photo,true,'Failed to load photo URL.'); }
        }
        updatePreview();
      });

      els.fields.photoFile.addEventListener('change', async ()=>{
        const f=els.fields.photoFile.files?.[0]; if(!f) return;
        const data=await resizeImage(f); students[idx].photo=data; els.fields.photoUrl.value=''; updatePreview();
      });

      els.form.addEventListener('submit',(e)=>{e.preventDefault(); updatePreview();});

      els.tools.flipBtn.addEventListener('click', ()=>{
        const c=document.getElementById(`card-${idx}`); if(!c)return;
        c.classList.toggle('flipped');
        const f=c.classList.contains('flipped');
        c.querySelector('.front').setAttribute('aria-hidden',f);
        c.querySelector('.back').setAttribute('aria-hidden',!f);
      });

      els.tools.paperSize.addEventListener('change',(e)=>{
        if(e.target.value==='Letter'){
          document.documentElement.style.setProperty('--page-w','215.9mm');
          document.documentElement.style.setProperty('--page-h','279.4mm');
        }else{
          document.documentElement.style.setProperty('--page-w','210mm');
          document.documentElement.style.setProperty('--page-h','297mm');
        }
        buildPrintPages('front');
      });

      els.tools.duplexMode.addEventListener('change',()=>{/* applied on build */});
      els.tools.mirrorBack.addEventListener('change',()=>{/* applied on build */});
      els.tools.cardsPerPage.addEventListener('change', ()=>{updateSelect(); buildPrintPages('front');});
      els.tools.imageMode.addEventListener('change', ()=>buildPrintPages('front'));

      document.getElementById('resetBtn').addEventListener('click', ()=>{localStorage.removeItem('glc_id_state_v2'); location.reload();});

      document.getElementById('addStudentBtn').addEventListener('click', ()=>{
        students.push({name:'',dob:'',adm:'',klass:'',gender:'Male',showGender:true,validForYears:1,validUntil:futureDate(1),photo:CONFIG.defaultPhoto,phone:'',email:'',address:''});
        idx=students.length-1; loadForm(); updateSelect(); updatePreview();
      });

      document.getElementById('removeStudentBtn').addEventListener('click', ()=>{
        if(students.length<=1) return;
        students.splice(idx,1); idx=Math.max(0,idx-1); loadForm(); updateSelect(); updatePreview();
      });

      els.fields.studentSelect.addEventListener('change',(e)=>{idx=parseInt(e.target.value,10); loadForm(); updatePreview();});

      // PRINT buttons: build only that side; no CSS mode classes anymore
      els.tools.printFrontsBtn.addEventListener('click', ()=>doPrint('front'));
      els.tools.printBacksBtn.addEventListener('click',  ()=>doPrint('back'));
    }

    (async function init(){
      try{
        const raw=localStorage.getItem('glc_id_state_v2');
        if(raw){const data=JSON.parse(raw); students=data.students||students; idx=Math.min(data.idx||0,students.length-1);}
      }catch{}
      bind();
      updateSelect();
      loadForm();
      try{await preload(CONFIG.defaultLogo);}catch{}
      updatePreview();
      setInterval(()=>{localStorage.setItem('glc_id_state_v2', JSON.stringify({students,idx}));},1500);
    })();
  })();
  </script>
</body>
</html>